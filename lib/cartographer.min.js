define(["postal","infuser","DOMBuilder"],function(a,b){var c;c={elementIdentifier:"map-id"};var d,b,e;d=function(){var a,b;return a=this,b=[],this.appendSource=function(a){return b.push(a)},this.prependSource=function(a){return b.unshift(a)},this.resolve=function(a,c,d){var e,f;return f=0,e=function(){},e=function(){var g,h;return g=(h=b[f])!=null?h.resolve:void 0,g?g(a,function(a){return c($(a)[0])},function(){return f++,e()}):d()},e()},a},e=new d,e.appendSource({resolve:function(a,b,d){var e;return e=$("["+c.elementIdentifier+'="'+a+'-template"]'),e.length>0?b(e[0]):d()}}),b=b||window.infuser,b&&e.appendSource({resolve:function(a,c,d){return b.get(a,function(a){return c(a)},function(a){return console.log("got "+a),d()})}});var f,g;f=function(){var b;return b=this,this.config=c,this.templates={},this.map=function(a,c,d){var e;return e=new r(a,c,d),b.templates[a]=e,!0},this.apply=function(c,d,e,f){var g;return e=e||function(b){return a.publish("cartographer","render."+c,{id:c,markup:b})},f=f||function(b){return a.publish("cartographer","render.error."+c,b)},b.templates[c]?(g=b.templates[c],g.apply(d,function(a){return e(a)})):d.__template__&&c?(b.map(c,d.__template__,d),b.apply(c,d,e,f)):f("No template with "+c+" has been mapped")},this.resolver=e,b},g=new f,a.subscribe("cartographer","api.*",function(a,b){if(b.topic==="api.map")return g.map(a.id,a.name,a.model);if(b.topic==="api.apply")return g.apply(a.id,a.model);if(b.topic==="api.templateSource")return g.resolver.appendSource(a.provider)}),a.subscribe("cartographer","event.*",function(a,b){var c;if(b.topic==="event.watch")return c=g.templates[a.id],c!=null?c.watchEvent(a.event):void 0;if(b.topic==="event.ignore")return c=g.templates[a.id],c!=null?c.ignoreEvent(a.event):void 0}),g;var h,i,j,k;h={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},i={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},j={hide:"hidden",title:"title",value:"value","class":"className"},k={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var l,m,n,o,p,q;n=function(a,b,c,d){var e,f,g,h;g=a||"";if(d){if(a===""&&b===c)return"";g=g===c?"":g}return f=b||"",e=g!==""&&f!==""?".":"",h=""+g+e+f,h},l=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},q=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(l(b,e,a[c]));return h}return l(b,d,a[c])},m=function(a,b,c){var d,e,f,g,h;if(a&&b){g=_.keys(c),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],h.push(q(a,b,d,c[d]));return h}},p=function(a,b){return a===b},o=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0};var r;r=function(b,d,f){var g,h,l,q,r,s,t;return r=this,g=function(a,b,d,f){var g,h,i,j,k;return g=(d!=null?(k=d.attributes[c.elementIdentifier])!=null?k.value:void 0:void 0)||"",g=g===r.name?"":g,i=n(b,g,r.name,!0),h=!d,j=o(a,g)||r.name,!p(i,b)&&o(a,g)||h?e.resolve(j,function(c){return c.nested=!0,q(a,b,c,f)},function(){return console.log("No template could be found for "+j)}):q(a,b,d,f)},q=function(a,b,d,e){var f,h,i,j,k,m,o,p,q,s,t,u,v,w;d||console.log("ELEMENT IS NULL AND SHOULDN'T BE!!!!!!"),a&&console.log("at "+b+" model is "+JSON.stringify(a)),k=(d!=null?(t=d.attributes[c.elementIdentifier])!=null?t.value:void 0:void 0)||"",m=n(b,k,!0,r.name),p=d.tagName.toUpperCase(),h=(u=d.children)!=null?u.length:void 0;if(h>0){i=[],o=function(b){var c;i.push(b);if(i.length===h)return c=function(b,c,e){var f,g,h,j,m,o,q,s,t,u,v,w;u=k===""?e:k,t=n(c,u,!0,r.name),console.log("model "+JSON.stringify(b)+", fqn "+c+" idx "+e),v=(u===t||u===void 0?b:b[u])||b,h=(v!=null?v.length:void 0)?v:v!=null?v.items:void 0;if(h&&h.length){s=[],g=i[0],r.template[t+"_add"]=function(a,b){return g(b,t,a)};for(q=0,w=h.length-1;0<=w?q<=w:q>=w;0<=w?q++:q--)s.push(function(){var a,b,c;c=[];for(a=0,b=i.length;a<b;a++)o=i[a],c.push(o(h,t,q));return c}());return f=l(p,d,t,u,s,a,b),r[t]=f,f}return j=function(){var a,b,c;c=[];for(a=0,b=i.length;a<b;a++)m=i[a],c.push(m(v,t));return c}(),f=l(p,d,t,u,j,a,b),r[t]=f,f},r.template[m]=c,e(c)},v=d.children,w=[];for(q=0,s=v.length;q<s;q++)f=v[q],w.push(g(a,m,f,function(a){return o(a)}));return w}return j=function(b,c,e){var f,g,h,i;h=k===""?e:k,g=n(c,h,!0,r.name),i=h===g||h===void 0?b:b[h];if(i!=null?i.value:void 0)i=i.value;return f=l(p,d,g,h,i,a,b),r[g]=f,f},r.template[m]=j,e(j)},l=function(a,b,d,e,f,g,h){var l,n,o,p;o={},p=b.textContent?b.textContent:b.value,l=(f!=null?f[e]:void 0)||f&&e?f||(f!=null?f[e]:void 0):p,n={};if(e||e===0)o[c.elementIdentifier]=e;b&&m(b,o,k),a==="INPUT"?(_.isObject(l)||(o.value=l),n=r.html[a](o)):n=r.html[a](o,l);if(h!=null?h[e]:void 0)f instanceof Array?m(h[e],n,j):m(h[e],n,i);return n},h=function(b){var c,d,e,f,g,h,i;e=r[b.key],h=b.operation,f=b.key.lastIndexOf("."),i=b.key.substring(0,f),d=b.key.substring(f+1);if(h==="add"){c=i+"_add";if(r.template[c])return g=r.template[c](b.value,i,d),a.publish("cartographer","markup.added",{operation:"added",parent:i,element:g})}else if(h="change")return r.template[b.key](b.value,i,d,function(b){return a.publish("cartographer","markup.created",{operation:"created",parent:i,element:b})})},s=function(){return r.changeSubscription!==void 0&&r.changeSubscription.unsubscribe(),r.changeSubscription=a.subscribe("cartographer","template."+r.id+".*",h)},t=function(){var a,b,c,d,e;d=r.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(r.watchEvent(a));return e},this.apply=function(a,b){return g(a,"",r.element,function(c){return r.top=c(a,""),t(),b(r.top)})},this.watchEvent=function(b){return r.top.on(b,function(b){var d,e;return d=r.id+"."+((e=b.target.attributes[c.elementIdentifier])!=null?e.value:void 0)+"."+b.type,a.publish("cartographer",d,b.target)}),r.watching=_.uniq(r.watching.push(b))},this.ignoreEvent=function(a){return r.top.off(eventname),r.watching=_.reject(r.watching,function(b){return b===a})},this.name=d,this.id=b,this.fqn="",this.element=void 0,this.html=DOMBuilder.dom,this.template={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],e.resolve(d,function(a){return r.element=a},function(){return console.log("No template could be found for "+d)}),s(),r}})