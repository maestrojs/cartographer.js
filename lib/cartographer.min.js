define(["postal","infuser","DOMBuilder"],function(a,b){var c;c={elementIdentifier:"map-id"};var d,b,e;d=function(){var a,b;return a=this,b=[],this.appendSource=function(a){return b.push(a)},this.prependSource=function(a){return b.unshift(a)},this.resolve=function(a,c,d){var e,f;return f=0,e=function(){},e=function(){var g,h;return g=(h=b[f])!=null?h.resolve:void 0,g?g(a,function(a){return c($(a)[0])},function(){return f++,e()}):d()},e()},a},e=new d,e.appendSource({resolve:function(a,b,d){var e;return e=$("["+c.elementIdentifier+'="'+a+'-template"]'),e.length>0?b(e[0]):d()}}),b=b||window.infuser,b&&e.appendSource({resolve:function(a,c,d){return b.get(a,function(a){return c(a)},function(a){return console.log("got "+a),d()})}});var f,g;f=function(){var b;return b=this,this.config=c,this.templates={},this.map=function(a,c,d){var e;return e=new s(a,c,d),b.templates[a]=e,!0},this.apply=function(c,d,e,f){var g;return e=e||function(b){return a.publish("cartographer","render."+c,{id:c,markup:b})},f=f||function(b){return a.publish("cartographer","render.error."+c,b)},b.templates[c]?(g=b.templates[c],g.apply(d,function(a){return e(a)})):d.__template__&&c?(b.map(c,d.__template__,d),b.apply(c,d,e,f)):f("No template with "+c+" has been mapped")},this.resolver=e,b},g=new f,a.subscribe("cartographer","api.*",function(a,b){if(b.topic==="api.map")return g.map(a.id,a.name,a.model);if(b.topic==="api.apply")return g.apply(a.id,a.model);if(b.topic==="api.templateSource")return g.resolver.appendSource(a.provider)}),a.subscribe("cartographer","event.*",function(a,b){var c;if(b.topic==="event.watch")return c=g.templates[a.id],c!=null?c.watchEvent(a.event):void 0;if(b.topic==="event.ignore")return c=g.templates[a.id],c!=null?c.ignoreEvent(a.event):void 0}),a.subscribe("postal","subscription.*",function(a,b){var c,d,e;if(b.topic==="subscription.created"&&a.exchange.match(/^cartographer[.].+/)){e=a.exchange.split(".")[1],d=g.templates[e];if(d)return c=a.topic.split("."),d.watchEvent(c[c.length-1])}else if(a.exchange.match(/^cartographer[.]*/)){e=a.exchange.split(".")[1],d=g.templates[e];if(d)return c=a.topic.split("."),d.ignoreEvent(c[c.length-1])}}),g;var h,i,j,k;h={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},i={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},j={hide:"hidden",title:"title",value:"value","class":"className"},k={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var l,m,n,o,p,q,r;n=function(a,b,c,d){var e,f,g,h;g=a||"";if(d){if(a===""&&b===c)return"";g=g===c?"":g}return f=b||"",e=g!==""&&f!==""?".":"",h=""+g+e+f,h},l=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},r=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(l(b,e,a[c]));return h}return l(b,d,a[c])},m=function(a,b,c){var d,e,f,g,h;if(a&&b){g=_.keys(c),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],h.push(r(a,b,d,c[d]));return h}},q=function(a,b){return a===b},p=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},o=function(a,b){var c,d;if(_(a[b]).isArray())return(c=a[b])!=null?(d=c[0])!=null?d.__template__:void 0:void 0};var s;s=function(b,d,f){var g,h,l,r,s,t,u,v;return t=this,h=function(a,b,d,f,g){var h,i,j,k,l,m;return h=(d!=null?(m=d.attributes[c.elementIdentifier])!=null?m.value:void 0:void 0)||"",h=h===t.name?"":h,j=n(b,h,t.name,!0),i=!d,k=p(a,h)||t.name,l=!g[b+"."+j],l&&!q(j,b)&&p(a,h)||i?e.resolve(k,function(c){return g[b+"."+j]=!0,s(a,b,c,f,g)},function(){return console.log("No template could be found for "+k)}):s(a,b,d,f,g)},g=function(a,b,c,d,e){var f;return f=function(f,g,h){var i,j,k,l,m,o,p,q,s,u,v,w;u=c===""?h:c,s=n(g,u,!0,t.name),v=(u===s||u===void 0?f:f[u])||f;if(v!=null?v.value:void 0)v=v.value;k=(v!=null?v.length:void 0)?v:v!=null?v.items:void 0;if(k&&k.length){q=[],j=e[0],t.template[s+"_add"]=function(a,b){return j(b,s,a)};for(p=0,w=k.length-1;0<=w?p<=w:p>=w;0<=w?p++:p--)q.push(function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)o=e[a],c.push(o(k,s,p));return c}());return i=r(a,b,s,u,q,d,f),t[s]=i,i}return l=function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)m=e[a],c.push(m(v,s));return c}(),i=r(a,b,s,u,l,d,f),t[s]=i,i}},s=function(a,b,d,f,i){var j,k,l,m,p,q,s,u,v,w,x,y,z,A,B,C;d||console.log("ELEMENT IS NULL AND SHOULDN'T BE!!!!!!"),q=(d!=null?(z=d.attributes[c.elementIdentifier])!=null?z.value:void 0:void 0)||"",s=n(b,q,!0,t.name),v=d.tagName.toUpperCase(),w=o(a,q);if(w&&!i[b+"."+q])return e.resolve(w,function(c){var e,j,k,l,m,n,o,p,r;i[b+"."+q]=!0,k=c.length>1?c:[c],l=k.length;if(l>0){m=[],n=function(b){var c;m.push(b);if(m.length===l)return c=g(v,d,q,a,m),t.template[s]=c,f(c)},j=function(a){return n(a)},r=[];for(o=0,p=k.length;o<p;o++)e=k[o],r.push(h(a,s,e,j,i));return r}},function(){return console.log("No template could be found for "+w)});l=(A=d.children)!=null?A.length:void 0;if(l>0){m=[],u=function(b){var c;m.push(b);if(m.length===l)return c=g(v,d,q,a,m),t.template[s]=c,f(c)},k=function(a){return u(a)},B=d.children,C=[];for(x=0,y=B.length;x<y;x++)j=B[x],C.push(h(a,s,j,k,i));return C}return p=function(b,c,e){var f,g,h,i;h=q===""?e:q,g=n(c,h,!0,t.name),i=h===g||h===void 0?b:b[h];if(i!=null?i.value:void 0)i=i.value;return f=r(v,d,g,h,i,a,b),t[g]=f,f},t.template[s]=p,f(p)},r=function(a,b,d,e,f,g,h){var l,n,o,p;o={},p=b.textContent?b.textContent:b.value,l=(f!=null?f[e]:void 0)||f&&e||b.children.length>1?f||(f!=null?f[e]:void 0):p,n={};if(e||e===0)o[c.elementIdentifier]=e;b&&m(b,o,k),a==="INPUT"?(_.isObject(l)||(o.value=l),n=t.html[a](o)):n=t.html[a](o,l);if(h!=null?h[e]:void 0)f instanceof Array?m(h[e],n,j):m(h[e],n,i);return n},l=function(b){var c,d,e,f,g,h,i;e=t[b.key],h=b.operation,f=b.key.lastIndexOf("."),i=b.key.substring(0,f),d=b.key.substring(f+1);if(h==="add"){c=b.key+"_add";if(t.template[c])return g=t.template[c](b.value,i,d),a.publish("cartographer","markup.added",{operation:"added",parent:i,markup:g})}else if(h="change")return t.template[b.key](b.value,i,d,function(b){return a.publish("cartographer","markup.created",{operation:"created",parent:i,markup:b})})},u=function(){return t.changeSubscription!==void 0&&t.changeSubscription.unsubscribe(),t.changeSubscription=a.subscribe("cartographer","template."+t.id+".*",l)},v=function(){var a,b,c,d,e;d=t.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(t.watchEvent(a));return e},this.apply=function(a,b){return h(a,"",t.element,function(c){return t.top=c(a,""),v(),b(t.top)},{})},this.watchEvent=function(b){return t.top&&$(t.top).on(b,function(b){var d,e;return d=((e=b.target.attributes[c.elementIdentifier])!=null?e.value:void 0)+"."+b.type,a.publish("cartographer."+t.id,d,b.target)}),t.watching.push(b),t.watching=_.uniq(t.watching)},this.ignoreEvent=function(a){return t.top.off(eventname),t.watching=_.reject(t.watching,function(b){return b===a})},this.name=d,this.id=b,this.fqn="",this.element=void 0,this.html=DOMBuilder.dom,this.template={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],e.resolve(d,function(a){return t.element=a},function(){return console.log("No template could be found for "+d)}),u(),t}})