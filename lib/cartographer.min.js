/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
var configuration;configuration={elementIdentifier:"map-id"};var SourceResolver,infuser,resolver;SourceResolver=function(){var a,b;return a=this,b=[],this.appendSource=function(a){return b.push(a)},this.prependSource=function(a){return b.unshift(a)},this.resolve=function(a,c,d){var e,f;return f=0,e=function(){},e=function(){var g;return g=b[f],g?g(a,function(a){return c($(a)[0])},function(){return f++,e()}):d()},e()},a},resolver=new SourceResolver,resolver.appendSource(function(a,b,c){var d;return d=$("["+configuration.elementIdentifier+'="'+a+'-template"]'),d.length>0?b(d[0]):c()}),infuser=infuser||window.infuser,infuser&&resolver.appendSource(function(a,b,c){return infuser.get(a,function(a){return b(a)},function(a){return c()})});var Cartographer,cartographer;Cartographer=function(){var a;return a=this,this.config=configuration,this.templates={},this.map=function(b,c){var d;return d=new Template(b,c),a.templates[b]=d,!0},this.apply=function(b,c,d,e){var f;return a.templates[b]?(f=a.templates[b],f.apply(c,function(a,b,c){return d(a,b,c)})):c.__template__&&b?(a.map(b,c.__template__,c),a.apply(b,c,d,e)):e(b,"render","No template with "+b+" has been mapped")},this.resolver=resolver,a},cartographer=new Cartographer,cartographer;var eventHandlers,modelTargets,modelTargetsForCollections,templateProperties;eventHandlers={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},modelTargets={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},modelTargetsForCollections={hide:"hidden",title:"title",value:"value","class":"className"},templateProperties={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var conditionalCopy,copyProperties,createFqn,externalItemTemplate,externalTemplate,isCurrent,propertyCopy;createFqn=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},conditionalCopy=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},propertyCopy=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(conditionalCopy(b,e,a[c]));return h}return conditionalCopy(b,d,a[c])},copyProperties=function(a,b,c){var d,e,f,g,h;if(a&&b){g=_.keys(c),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],h.push(propertyCopy(a,b,d,c[d]));return h}},isCurrent=function(a,b){return a===b},externalTemplate=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},externalItemTemplate=function(a,b){var c,d;if(_(a[b]).isArray())return(c=a[b])!=null?(d=c[0])!=null?d.__template__:void 0:void 0};var Template;Template=function(a,b){var c,d,e,f,g,h,i,j;return i=this,e=function(a,b,c,d,e){return a()&&!d[c]?(resolver.resolve(b,function(a){return d[c]=!0,e(a)},function(){return console.log("Could not resolve tempalte "+b)}),!0):!1},d=function(a,b,c,d,f){var h,j,k,l,m,n,o,p;if(c&&c.nodeType&&c.nodeType!==1)return d(function(){return c});h=(c!=null?(p=c.attributes[configuration.elementIdentifier])!=null?p.value:void 0:void 0)||"",k=createFqn(b,h,i.name,!0)||i.id,j=!c,m=externalTemplate(a,h)||i.name,o=function(){return!isCurrent(k,b)&&externalTemplate(a,h)||j},b=!b||b===""?i.id:b,n=b+"."+k,l=function(c){return g(a,b,c,d,f)};if(!e(o,m,n,f,l))return g(a,b,c,d,f)},c=function(a,b,c,d,e){var g;return g=function(g,h,j){var k,l,m,n,o,p,q,r,s,t,u,v;t=c===""?j:c,s=createFqn(h,t,!0,i.name),u=(t===s||t===void 0?g:g[t])||g,u=(u!=null?u.value:void 0)||u;if(e){m=(u!=null?u.length:void 0)?u:u!=null?u.items:void 0;if(m&&m.length){r=[],l=e.slice(0),i.template[s+"_add"]=function(a,b){var c,d,e,f;f=[];for(d=0,e=l.length;d<e;d++)c=l[d],f.push(c(b,s,a));return f};for(q=0,v=m.length-1;0<=v?q<=v:q>=v;0<=v?q++:q--)r.push(function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)p=e[a],c.push(p(m,s,q));return c}());return k=f(a,b,s,t,r,d,g),i[s]=k,k}return n=function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)o=e[a],c.push(o(u,s));return c}(),k=f(a,b,s,t,n,d,g),i[s]=k,k}return k=f(a,b,s,t,u,d,g),i[s]=k,k}},h=function(a,b,e,f,g,h,j,k){var l,m,n,o,p,q,r;m=h.length,n=[],o=function(d){var h;if(d.nodeType!==void 0&&d.nodeType!==1)return j(d);n.push(d);if(n.length===m)return h=c(a,f,g,b,n),i.template[e]=h,j(h)},r=[];for(p=0,q=h.length;p<q;p++)l=h[p],r.push(d(b,e,l,o,k));return r},g=function(a,b,d,f,g){var j,k,l,m,n,o,p,q,r,s,t;m=(d!=null?(t=d.attributes[configuration.elementIdentifier])!=null?t.value:void 0:void 0)||"",n=createFqn(b,m,!0,i.name),q=d.tagName.toUpperCase(),r=externalItemTemplate(a,m),s=b+"."+m,p=function(){return r},o=function(b){var c;return c=b.length>1?b:[b],h(q,a,n,d,m,c,f,g)};if(!e(p,r,s,g,o))return j=d.childNodes,k=j.length,k>0?h(q,a,n,d,m,j,f,g):(l=c(q,d,m,a),i.template[n]=l,f(l))},f=function(a,b,c,d,e,f,g){var h,j,k;k={},h=_.isArray(e)&&!_.isString(e)?e||(e!=null?e[d]:void 0):(e!=null?e[d]:void 0)||e,h=b.children.length===0&&d===void 0?b.textContent:h,j={};if(d||d===0)k[configuration.elementIdentifier]=c;b&&copyProperties(b,k,templateProperties),a==="INPUT"?(_.isObject(h)||(k.value=h),j=i.html[a](k)):j=i.html[a](k,h);if(g!=null?g[d]:void 0)e instanceof Array?copyProperties(g[d],j,modelTargetsForCollections):copyProperties(g[d],j,modelTargets);return j},j=function(){var a,b,c,d,e;d=i.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(i.watchEvent(a.event,a.handler));return e},this.apply=function(a,b){return d(a,i.id,i.element,function(c){return i.top=c(a,i.id),$(i.top).attr(configuration.elementIdentifier,i.id),j(),b(i.id,"render",i.top)},{})},this.watchEvent=function(a,b){return i.top&&$(i.top).on(a,function(a){var c,d;return c=(d=a.target.attributes[configuration.elementIdentifier])!=null?d.value:void 0,b(i.id,c,a.target,a.type)}),i.watching.push({event:a,handler:b}),i.watching=_.uniq(i.watching)},this.ignoreEvent=function(a){return i.top&&i.top.off(eventname),i.watching=_.reject(i.watching,function(b){return b.event===a})},this.update=function(a,b,c){var d,e,f,g;e=a.lastIndexOf("."),g=a.substring(0,e),d=a.substring(e+1);if(i.template[a])return f=i.template[a](b,g,d),c(a,"update",f)},this.add=function(a,b,c){var d,e,f,g,h,j;g=a.lastIndexOf("."),j=a.substring(0,g),e=a.substring(g+1),d=a+"_add";if(i.template[d])return f=i[a].children.length,h=i.template[d](f,b),c(a,"add",h)},this.name=b,this.id=a,this.fqn="",this.element=void 0,this.html=DOMBuilder.dom,this.template={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],resolver.resolve(b,function(a){return i.element=a},function(){return console.log("No template could be found for "+b)}),i};var PostalSetup,setup;PostalSetup=function(){var a;return a=this,this.apply=function(a){var b,c;return c=a.template,b=a.model,cartographer.apply(c,b,function(a,b,d){return postal.publish("cartographer","render."+c,{template:c,markup:d,operation:"render"})},function(a){return postal.publish("cartographer","render."+a,{template:c,error:a,operation:"render"})})},this.map=function(a){return cartographer.map(a.template,a.name)},this.resolver=function(a){return a.order==="prepend"?cartographer.resolver.prependSource(a.resolver):cartographer.resolver.appendSource(a.resolver)},this.add=function(a){var b,c,d,e;return e=a.template,b=a.id,c=a.model,d=cartographer.templates[e],d.add(b,c,function(a,c,d){return postal.publish("cartographer","render.{templateId}",{template:e,parent:b,markup:d,operation:"add"})})},this.update=function(a){var b,c,d,e;return e=a.template,b=a.id,c=a.model,d=cartographer.templates[e],d.update(b,c,function(a,c,d){return postal.publish("cartographer","render.{templateId}",{template:e,id:b,markup:d,operation:"update"})})},this.watch=function(a){var b;return b=cartographer.templates[a.template],b.watchEvent(a.event,function(a,b,c,d){return postal.publish("cartographer."+a,""+b+"."+d,{element:c})})},this.ignore=function(a){var b;return b=cartographer.templates[a.template],b.ignoreEvent(a.event)},postal.subscribe("cartographer","api",function(b,c){var d;return d=b.operation,a[d](b)}),postal.subscribe("postal","subscription.*",function(b,c){var d,e,f;if(b.exchange.match(/^cartographer[.]*/)){f=b.exchange.split(".")[1];if(cartographer.templates[f]){e=b.topic.split("."),d={template:f,event:e[e.length-1]};if(c.topic==="subscription.created"&&b.exchange.match(/^cartographer/))return a.watch(d);if(b.exchange.match(/^cartographer/))return a.ignore(d)}}})},setup=new PostalSetup