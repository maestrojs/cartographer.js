/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
var configuration;configuration={elementIdentifier:"data-id",templateIdentifier:"data-template"};var SourceResolver,infuser,resolver;SourceResolver=function(){var a,b;return a=this,b=[],this.appendSource=function(a){return b.push(a)},this.prependSource=function(a){return b.unshift(a)},this.resolve=function(a,c,d){var e,f;return f=0,e=function(){},e=function(){var g;return g=b[f],g?g(a,function(a){return c($(a))},function(){return f++,e()}):d()},e()},a},resolver=new SourceResolver,resolver.appendSource(function(a,b,c){var d;return d=$("#"+a+"-template"),d.length>0?b(d[0]):c()}),infuser=infuser||window.infuser,infuser&&resolver.appendSource(function(a,b,c){return infuser.get(a,function(a){return b(a)},function(a){return c()})});var Cartographer,cartographer;Cartographer=function(){var a;return a=this,this.config=configuration,this.templates={},this.containerLookup={},this.instanceCache={},this.map=function(b){var c;return c=new Template(b),a.templates[b]=c,!0},this.apply=function(b,c,d,e,f){var g,h;return this.containerLookup[c]=a.templates[b],a.templates[b]?(g=a.templates[b],g.apply(c,d,function(b,c,d){return a.instanceCache[b]=d,e(b,c,d)})):d.__template__&&c?(h=d.__template__,a.map(h),a.apply(h,c,d,e,f)):f(c,"render","No template with "+b+" has been mapped")},this.add=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.add(c,d,e)},this.update=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.update(c,d,e)},this.watchEvent=function(b,c,d){var e;if(a.containerLookup[b])return e=a.containerLookup[b],e.watchEvent(b,c,d)},this.ignoreEvent=function(b,c){var d;if(a.containerLookup[b])return d=a.containerLookup[b],d.ignore(b,c)},this.resolver=resolver,a},cartographer=new Cartographer,cartographer;var Template;Template=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;return m=this,f=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},k=function(a,b,c){return m.templates[b]?(c(m.templates[b]),!0):(resolver.resolve(a,function(a){return c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},g=function(a){var b;return a!=null?(b=a.attributes[configuration.templateIdentifier])!=null?b.value:void 0:void 0},c=function(a,d,e,f){var h,i,j,l,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;if((d!=null?d.length:void 0)&&(!d.nodeType||d.nodeType===1)){if(d.length>1){w=d.length,s=0,t=new Array(w),u=function(a){t[s++]=a,console.log("got factory "+a+" for index "+s);if(s===w)return f(function(a,b,c,d,e){var f,g,h,i;i=[];for(g=0,h=t.length;g<h;g++)f=t[g],i.push(f(a,b,c,d,e));return i})},B=[];for(r=0,z=w-1;0<=z?r<=z:r>=z;0<=z?r++:r--)B.push(c(a,d[r],e,u));return B}return c(a,d[0],e,f)}if((d!=null?d.nodeType:void 0)&&d.nodeType!==1)return f(function(){return arguments[4](d.nodeValue)});v=d?v=g(d):a,q=d!=null?(A=d.attributes[configuration.elementIdentifier])!=null?A.value:void 0:void 0,p=a+(q?"."+q:"");if(v)return e[v]?f(function(){return m.factories[v].apply(m,[].slice.call(arguments,0))}):(e[v]=v,k(v,p+"."+v,function(b){return c(a,b,e,function(a){return m.factories[v]=a,f(a)})}));l=d.childNodes,j=l.length,o=function(a){var c;return c=b(d,q,p,a,e),m.factories[p]=c,f(c)};if(l.length>0){n=[],h=function(a){n.push(a);if(n.length===j)return o(n)},C=[];for(x=0,y=l.length;x<y;x++)i=l[x],C.push(c(p,i,e,h));return C}return o([])},h=function(a,b){return _.isFunction(a)?a.call(b):a},i=function(a,b){if(a&&a[b])return a[b];return},j=function(a,b,d,e,f,g,h){return m.templates[a]?m.templates[a](b,d,e,f,h):k(a,a,function(i){return c(g.elementFqn,i,templates,function(c){return m.templates[a]=c,c(b,d,e,f,h)})})},e=function(a,b,c,d,e,f,g){var h,i,j,k,m,n,o,p,q,r,s,t,u;o=a>0,o||(a=1),k=f.childrenToCreate,s=k.length*a,n=0,q=new Array(s),r=function(a,e){q[n++]=e;if(n>=s)return g(l(f.tag,f.element,d,a,f.elementId,q,c,b))},u=[];for(p=0,t=a-1;0<=t?p<=t:p>=t;0<=t?p++:p--)u.push(function(){var a,f,g;g=[];for(a=0,f=k.length;a<f;a++)m=k[a],i=e,j=c,h=d,e===void 0&&o&&(i=p,j=c[i],h=""+d+"."+i),g.push(m(b,j,h,i,function(a){return r(i,a)}));return g}());return u},d=function(a,b,c,d,g,k){var n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;return s=g.elementId,d=s||d,u=s!==void 0&&s!=="",t=u?d:"",z=f(c,t,!1,m.name),y=h(b.__template__,b),w=h((B=b[d])!=null?B.__template__:void 0,b),x=h(i(b[d],"__value__")||b[d],b),p=u?b[d]:b,A="",w&&(A=w,delete b[d].__template__),y&&(A=y,delete b.__template__),A?j(A,a,b,c,d,g,k):(o=g!=null?g.childrenToCreate.slice(0):void 0,n=o.length,n>0?(q=i(x,"__items__")||x,r=q?q.length:0,v=r&&!_.isString(q)?q:void 0,m.factories[z+"_add"]=function(b,c,d){return e(0,a,c,z,b,g,d)},v?e(r,a,p,z,void 0,g,k):e(0,a,p,z,d,g,k)):k(l(g.tag,g.element,z,d,u,x,b,a)))},b=function(a,b,c,e,f){var g,h;return h=a.tagName.toUpperCase(),g={tag:h,element:a,elementId:b,elementFqn:c,childrenToCreate:e,templates:f},function(a,b,c,e,f){return d(a,b,c,e,g,f)}},l=function(a,b,c,d,e,f,g,h){var i,j,k,l;k={},i=_.isString(f)?f:_.isArray(f)?f||(f!=null?f[d]:void 0):(f!=null?f[d]:void 0)||f,i=b.children.length===0&&d===void 0&&(_.isObject(f)||_.isArray(f))?b.textContent:i,j={},e&&(k[configuration.elementIdentifier]=c),b.className&&(k["class"]=b.className),b.type&&(k.type=b.type),b.value&&(k.value=b.value),b.id&&(k.id=b.id);if(g!=null?(l=g[d])!=null?l["class"]:void 0:void 0)k["class"]=g[d]["class"];return a==="INPUT"?(_.isObject(i)||(k.value=i),j=m.html[a](k)):a==="IMG"?(k=$.extend(k,{src:i.src||i||b.src,alt:i.alt||i||b.alt,width:i.width||b.width||"",height:i.height||b.height||""}),j=m.html[a](k)):a==="A"?(k=$.extend(k,{href:g.link||b.href,alt:g.alt||i||b.alt}),j=m.html[a](k,i)):j=m.html[a](k,i),e&&(m.generated[h][c]=j),j},n=function(a){var b,c,d,e,f;e=m.watching,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(m.watchEvent(a,b.event,b.handler));return f},this.apply=function(a,b,c){var d,e;return d=$.extend(!0,{},b),m.generated[a]={},m.ready?e=m.render(a,d,a,void 0,function(b){var d;return d=$(b)[0],$(d).attr(configuration.elementIdentifier,a),m.generated[a].top=d,n(a),c(a,d,"render")}):m.deferredApplyCalls.push(function(){return m.apply(a,d,c)})},this.watchEvent=function(a,b,c){return $(m.generated[a].top).on(b,function(a){var b,d;return b=(d=a.target.attributes[configuration.elementIdentifier])!=null?d.value:void 0,c(m.id,b,a.target,a.type)}),m.watching.push({event:b,handler:c}),m.watching=_.uniq(m.watching)},this.ignoreEvent=function(a,b){return m.generated[a].top&&m.generated[a].top.off(eventname),m.watching=_.reject(m.watching,function(a){return a.event===b})},this.update=function(a,b,c){var d,e,f,g;e=a.lastIndexOf("."),g=a.split(".")[0],f=a.substring(0,e),d=a.substring(e+1);if(m.factories[a])return m.factories[a](g,b,f,d,function(b){var d;return d=b,c(a,d,"update")})},this.add=function(a,b,c){var d,e,f,g,h,i;g=a.lastIndexOf("."),i=a.split(".")[0],h=a.substring(0,g),e=a.substring(g+1),d=a+"_add";if(m.factories[d])return f=$(m.generated[i][a])[0].children.length,m.factories[d](f,b,function(b){var d;return d=b,c(a,d,"add")})},this.name=a,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.generated={},this.changeSubscription=void 0,this.watching=[],this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},c(m.name,void 0,{},function(a){var b,c,d,e,f;m.render=a,m.ready=!0;if(m.deferredApplyCalls.length>0){e=m.deferredApplyCalls,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b());return f}}),m}