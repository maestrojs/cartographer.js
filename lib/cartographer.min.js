(function(a){var b,c;b=function(){var a,b,c;return b=this,c=[],a=function(a){var b;return b=$("#"+a+"-template > :only-child"),b.length>0?b[0]:null},this.addSource=function(a){return c.push(a)},this.resolve=function(b,d,e){var f,g,h;return h=a(b),h?d(h):(g=0,f=function(){},f=function(){return c[g].resolve(b,function(a){return d($(a)[0],function(){return g++,f()})})},f())},infuser&&b.addSource({resolve:function(a,b,c){return infuser.get(a,function(a){return b(a)},c)}}),b},c=new b;var d;d=function(){var a;return a=this,postal.channel("cartographer").subscribe(function(b){if(b.map)return a.map(b.name,b.namespace);if(b.apply)return a.apply(b.template,b.proxy,b.render,b.error);if(b.addSource)return a.resolver.addSource(b.provider)}),this.templates={},this.map=function(b,c,d){var f;return f=new e(b,c,d),a.templates[b]=f},this.apply=function(b,c,d,e){var f;return b=b||(b=c.__template__),f=a.templates[b],f?f.apply(c,function(a){return d?d(a,f.target,f.fqn):$("#"+f.target).fadeOut(200,function(){return $(this).html(a).fadeIn(300)})}):(a.map(b,c.getPath()),a.apply(b,c))},this.resolver=c,a},a.cartographer=new d;var e,f;e=function(a,b,d){var e,f,g,h,i,j,k;k=this;var l,m,n,o;return l={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},m={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},n={hide:"hidden",title:"title",value:"value","class":"className"},o={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"},e=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(b[e]=a[c]||b[e]);return h}return b[d]=a[c]||b[d]},f=function(a,b,c){var d,f,g,h,i;if(a&&b){h=_.keys(c),i=[];for(f=0,g=h.length;f<g;f++)d=h[f],i.push(e(a,b,d,c[d]));return i}},g=function(a,b,d,e,f){var g,i,l,m,n;return i=e!=null?e.id:void 0,m=h(d,i,!0),l="",g=!0,e?m!==d&&((n=b[m])!=null?n.__template__:void 0)?(l=b[m].__template__,g=!0):g=!1:l=k.name,!e||g?c.resolve(l,function(c){return e=c,e.nested=!0,j(a,b,d,e,f)}):j(a,b,d,e,f)},j=function(a,b,c,d,e){var f,j,k,l,m,n,o,p,q,r,s;m=d.id,l=h(c,m),o=d.tagName.toUpperCase(),a=a||b;if(d.children!==void 0&&d.children.length>0){k=[],n=function(c){var f;k.push(c);if(k.length===d.children.length)return f=function(c,e,f,g){var j,l,n,p,q,r,s,t,u,v,w;j=m===""?g:m,u=h(f,j),v=j===u||j===void 0?e:e!=null?e[j]:void 0;if(v!=null?v.value:void 0)v=v.value;q=(v!=null?v.length:void 0)?v:v!=null?v.items:void 0;if(q&&q.length){t=[],p=k[0],a.template[u+"_add"]=function(a,b){return p(c,b,u,a)};for(s=0,w=q.length-1;0<=w?s<=w:s>=w;0<=w?s++:s--)t.push(function(){var a,b,d;d=[];for(a=0,b=k.length;a<b;a++)l=k[a],d.push(l(c,q,u,s));return d}());return n=i(a,c,o,d,u,j,t,b,e),a[u]=n,n}return r=function(){var a,b,d;d=[];for(a=0,b=k.length;a<b;a++)l=k[a],d.push(l(c,v,u));return d}(),n=i(a,c,o,d,u,j,r,b,e),a[u]=n,n},a.template[l]=f,e(f)},r=d.children,s=[];for(p=0,q=r.length;p<q;p++)j=r[p],s.push(g(a,b,l,j,function(a){return n(a)}));return s}return f=function(c,e,f,g){var j,k,n,p;return j=m===""?g:m,n=h(f,j,!0),p=j===l?e:e!=null?e[j]:void 0,k=i(a,c,o,d,n,j,p,b,e),a[n]=k,k},a.template[l]=f,e(f)},h=function(a,b,c){var d,e,f,g;return f=a||"",c&&(f=f===k.name?"":f),e=b||"",d=f!==""&&e!==""?".":"",g=""+f+d+e,g},i=function(a,b,c,d,e,g,h,i,j){var k,l,p,q;p={},q=d.textContent?d.textContent:d.value,k=h?h:q,l={};if(g||g===0)p.id=g;d&&f(d,p,o),c==="INPUT"?(_.isObject(k)||(p.value=k),l=b[c](p)):l=b[c](p,k);if(j!=null?j[g]:void 0)h instanceof Array?f(j[g],l,n):f(j[g],l,m);return l},this.apply=function(a,b){return g(k,a,"",k.element,function(c){return b(c(k.html,a))})},this.name=a,this.namespace="",this.fqn="",this.element=void 0,this.eventChannel=postal.channel(b+"_events"),this.html=DOMBuilder.dom,this.template={},this.changeSubscription=void 0,this.target=d||(d=a),c.resolve(a,function(a){return k.element=a}),k},f=function(){var a,b,c,d;return a=function(a){var b,c,d,e,f,g,h,i,j;if(a.event!=="read"){e=self[a.key],f=a.key.lastIndexOf("."),h=a.key.substring(0,f),d=a.key.substring(f+1),i="value",b=a.key;if(d==="value"||!e)e=self[h],i=d,b=h;if(a.event==="wrote"){if(d==="__template__")return cartographer.apply(a.info.value,a.parent);if(e&&self.template[b]&&a.info.value&&a.info.value.isProxy)return j=a.info.value.getRoot?a.info.value.getRoot():a.info.value,$(self[b]).replaceWith(self.template[b](self.html,j,h));if(a.info&&e)return conditionalCopy(a.info,e,"value",modelTargets[i])}else if(a.event==="added"){c=h+"_add";if(self.template[c])return g=self.template[c](d,a.parent),$(self[h]).append(g)}}},b=function(a,b,c,e,f){var g,h,i,j,k;if(a){j=_.keys(eventHandlers),k=[];for(h=0,i=j.length;h<i;h++)g=j[h],k.push(d(g,eventHandlers[g],a,b,c,e,f));return k}},c=function(b,c){return self.changeSubscription!==void 0&&self.changeSubscription.unsubscribe(),self.changeSubscription=postal.channel(c).subscribe(a)},d=function(a,b,c,d,e,f,g){var h,i;return h=c[a],h?(i=function(a){return h.apply(c,[d,{id:e,control:g[e],event:b,context:g,info:a}])},f[b]=i):f[b]=function(a){return b==="onchange"&&a.stopPropagation(),g.eventChannel.publish({id:e,model:c,control:g[e],event:b,context:g,info:a})}}}})(window)