(function(a){var b,c;b=function(){var a,b,c;return b=this,c=[],a=function(a){var b;return b=$("#"+a+"-template > :only-child"),b.length>0?b[0]:null},this.addSource=function(a){return c.push(a)},this.resolve=function(b,d,e){var f,g,h;return h=a(b),h?d(h):(g=0,f=function(){},f=function(){return c[g].resolve(b,function(a){return d($(a)[0],function(){return g++,f()})})},f())},infuser&&b.addSource({resolve:function(a,b,c){return infuser.get(a,function(a){return b(a)},c)}}),b},c=new b;var d;d=function(){var a;return a=this,postal.channel("cartographer").subscribe(function(b){if(b.map)return a.map(b.name,b.namespace);if(b.apply)return a.apply(b.template,b.proxy,b.render,b.error);if(b.addSource)return a.resolver.addSource(b.provider)}),this.templates={},this.map=function(b,c,d){var f;return f=new e(b,c,d),a.templates[b]=f},this.apply=function(b,c,d,e){var f;return b=b||(b=c.__template__),f=a.templates[b],f?f.apply(c,function(a){return d?d(a,f.target,f.fqn):$("#"+f.target).fadeOut(200,function(){return $(this).html(a).fadeIn(300)})}):(a.map(b,c.getPath()),a.apply(b,c))},this.resolver=c,a},a.cartographer=new d;var e,f;e=function(a,b,d){var e,f,g,h,i,j,k,l;l=this;var m,n,o,p;return m={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},n={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},o={hide:"hidden",title:"title",value:"value","class":"className"},p={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"},e=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(b[e]=a[c]||b[e]);return h}return b[d]=a[c]||b[d]},f=function(a,b,c){var d,f,g,h,i;if(a&&b){h=_.keys(c),i=[];for(f=0,g=h.length;f<g;f++)d=h[f],i.push(e(a,b,d,c[d]));return i}},g=function(a,b,d,e,f){var g,i,j,m,n;return i=e!=null?e.id:void 0,m=h(d,i),j="",g=!0,e?m!==d&&((n=b[m])!=null?n.__template__:void 0)?(j=b[m].__template__,g=!0):g=!1:j=l.name,!e||g?c.resolve(j,function(c){return e=c,e.nested=!0,k(a,b,d,e,f)}):k(a,b,d,e,f)},k=function(a,b,c,d,e){var f,k,l,m,n,o,p,q,r,s,t;n=d.id,m=i(c,n),p=d.tagName.toUpperCase(),a=a||b;if(d.children!==void 0&&d.children.length>0){l=[],o=function(c){var f;l.push(c);if(l.length===d.children.length)return f=function(c,e,f,g){var h,k,m,o,q,r,s,t,u,v,w;h=n===""?g:n,u=i(f,h),v=h===u||h===void 0?e:e!=null?e[h]:void 0;if(v!=null?v.value:void 0)v=v.value;q=(v!=null?v.length:void 0)?v:v!=null?v.items:void 0;if(q&&q.length){t=[],o=l[0],a.template[u+"_add"]=function(a,b){return o(c,b,u,a)};for(s=0,w=q.length-1;0<=w?s<=w:s>=w;0<=w?s++:s--)t.push(function(){var a,b,d;d=[];for(a=0,b=l.length;a<b;a++)k=l[a],d.push(k(c,q,u,s));return d}());return m=j(a,c,p,d,u,h,t,b,e),a[u]=m,m}return r=function(){var a,b,d;d=[];for(a=0,b=l.length;a<b;a++)k=l[a],d.push(k(c,v,u));return d}(),m=j(a,c,p,d,u,h,r,b,e),a[u]=m,m},a.template[m]=f,e(f)},s=d.children,t=[];for(q=0,r=s.length;q<r;q++)k=s[q],t.push(g(a,b,m,k,function(a){return o(a)}));return t}return f=function(c,e,f,g){var i,k,l,o;return i=n===""?g:n,l=h(f,i),o=i===m?e:e!=null?e[i]:void 0,k=j(a,c,p,d,l,i,o,b,e),a[l]=k,k},a.template[m]=f,e(f)},h=function(a,b){var c,d,e,f;return d=a||"",e=b||"",d=d===l.name?"":d,f=d!==""&&e!==""?".":"",c=""+d+f+e,c},i=function(a,b){var c,d,e,f;return d=a||"",e=b||"",f=d!==""&&e!==""?".":"",c=""+d+f+e,c},j=function(a,b,c,d,e,g,h,i,j){var k,l,m,q;m={},q=d.textContent?d.textContent:d.value,k=h?h:q,l={};if(g||g===0)m.id=g;d&&f(d,m,p),c==="INPUT"?(_.isObject(k)||(m.value=k),l=b[c](m)):l=b[c](m,k);if(j!=null?j[g]:void 0)h instanceof Array?f(j[g],l,o):f(j[g],l,n);return l},this.apply=function(a,b){return g(l,a,"",l.element,function(c){return b(c(l.html,a))})},this.name=a,this.namespace="",this.fqn="",this.element=void 0,this.eventChannel=postal.channel(b+"_events"),this.html=DOMBuilder.dom,this.template={},this.changeSubscription=void 0,this.target=d||(d=a),c.resolve(a,function(a){return l.element=a}),l},f=function(){var a,b,c,d;return a=function(a){var b,c,d,e,f,g,h,i,j;if(a.event!=="read"){e=self[a.key],f=a.key.lastIndexOf("."),h=a.key.substring(0,f),d=a.key.substring(f+1),i="value",b=a.key;if(d==="value"||!e)e=self[h],i=d,b=h;if(a.event==="wrote"){if(d==="__template__")return cartographer.apply(a.info.value,a.parent);if(e&&self.template[b]&&a.info.value&&a.info.value.isProxy)return j=a.info.value.getRoot?a.info.value.getRoot():a.info.value,$(self[b]).replaceWith(self.template[b](self.html,j,h));if(a.info&&e)return conditionalCopy(a.info,e,"value",modelTargets[i])}else if(a.event==="added"){c=h+"_add";if(self.template[c])return g=self.template[c](d,a.parent),$(self[h]).append(g)}}},b=function(a,b,c,e,f){var g,h,i,j,k;if(a){j=_.keys(eventHandlers),k=[];for(h=0,i=j.length;h<i;h++)g=j[h],k.push(d(g,eventHandlers[g],a,b,c,e,f));return k}},c=function(b,c){return self.changeSubscription!==void 0&&self.changeSubscription.unsubscribe(),self.changeSubscription=postal.channel(c).subscribe(a)},d=function(a,b,c,d,e,f,g){var h,i;return h=c[a],h?(i=function(a){return h.apply(c,[d,{id:e,control:g[e],event:b,context:g,info:a}])},f[b]=i):f[b]=function(a){return b==="onchange"&&a.stopPropagation(),g.eventChannel.publish({id:e,model:c,control:g[e],event:b,context:g,info:a})}}}})(window)