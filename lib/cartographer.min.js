/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
var configuration,createChildren,createFqn,elementTemplate,getActualValue,getHtmlFromList,getNestedValue;configuration={elementIdentifier:"data-id",templateIdentifier:"data-template"},createChildren=function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r;l=f.childrenToCreate,n=a>0,a||(a=1),j=e,k=c,i=d,h=[];for(o=0,r=a-1;0<=r?o<=r:o>=r;0<=r?o++:o--){e===void 0&&n&&(j=o,k=c[j],i=""+d+"."+j);for(p=0,q=l.length;p<q;p++)m=l[p],h.push(createCallback(self,m,[b,k,i,j]))}return forkJoin(h,g)},createFqn=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},elementTemplate=function(a){var b;return a!=null?(b=a.attributes[configuration.templateIdentifier])!=null?b.value:void 0:void 0},getActualValue=function(a,b){return _.isFunction(a)?a.call(b):a},getHtmlFromList=function(a,b){return $(b.DIV({},a)).html()},getNestedValue=function(a,b){if(a&&a[b])return a[b];return};var createCallback,forkJoin,queueByArgList,queueByFunctionList;forkJoin=function(a,b,c){var d,e,f,g,h,i,j,k,l;c||(c=1),j=a.length*c,h=new Array(j),e=0,i=function(a,c){e++,h[a]=c;if(e===j)return b(h)},d=0,l=[];for(g=0,k=c-1;0<=k?g<=k:g>=k;0<=k?g++:g--)l.push(function(){var b,c,e;e=[];for(b=0,c=a.length;b<c;b++)f=a[b],f(function(a){return i(d,a)}),e.push(d++);return e}());return l},queueByArgList=function(a,b,c){var d,e,f,g;d=c.length,f=new Array(d);for(e=0,g=d-1;0<=g?e<=g:e>=g;0<=g?e++:e--)f[e]=createCallback(a,b,c[e]);return f},queueByFunctionList=function(a,b,c){var d,e,f,g;d=b.length,f=new Array(d);for(e=0,g=d-1;0<=g?e<=g:e>=g;0<=g?e++:e--)f[e]=createCallback(a,b[e],c);return f},createCallback=function(a,b,c){return function(d){return b.apply(a,c.concat(d))}};var SourceResolver,infuser,resolver;SourceResolver=function(){function a(){this.sources=[]}return a.prototype.appendSource=function(a){return this.sources.push(a)},a.prototype.prependSource=function(a){return this.sources.unshift(a)},a.prototype.resolve=function(a,b,c){var d,e,f;return f=this,e=0,d=function(){},d=function(){var g;return g=f.sources[e],g?g(a,function(a){return b($(a))},function(){return e++,d()}):c()},d()},a}(),resolver=new SourceResolver,resolver.appendSource(function(a,b,c){var d;return d=$("#"+a+"-template"),d.length>0?b(d[0]):c()}),infuser=infuser||window.infuser,infuser&&resolver.appendSource(function(a,b,c){return infuser.get(a,function(a){return b(a)},function(a){return c()})});var Cartographer,cartographer;Cartographer=function(){function a(){this.config=configuration,this.templates={},this.containerLookup={},this.instanceCache={},this.resolver=resolver}return a.prototype.map=function(a){var b;return b=new Template(a),this.templates[a]=b,!0},a.prototype.apply=function(a,b,c,d,e){var f,g,h;return f=this,this.containerLookup[b]=this.templates[a],this.templates[a]?(g=this.templates[a],g.apply(b,c,function(a,b,c){return f.instanceCache[a]=c,d(a,b,c)})):c.__template__&&b?(h=c.__template__,this.map(h),this.apply(h,b,c,d,e)):e(b,"render","No template with "+a+" has been mapped")},a.prototype.add=function(a,b,c,d){var e;if(this.containerLookup[a])return e=this.containerLookup[a],e.add(b,c,d)},a.update=function(a,b,c,d){var e;if(this.containerLookup[a])return e=this.containerLookup[a],e.update(b,c,d)},a.watchEvent=function(a,b,c){var d;if(this.containerLookup[a])return d=this.containerLookup[a],d.watchEvent(a,b,c)},a.ignoreEvent=function(a,b){var c;if(this.containerLookup[a])return c=this.containerLookup[a],c.ignore(a,b)},a}(),cartographer=new Cartographer,cartographer;var Template;Template=function(){function a(a){var b;this.name=a,b=this,this.name=a,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},this.crawl(this.name,void 0,{},function(a){var c,d,e,f,g;b.render=a,b.ready=!0;if(b.deferredApplyCalls.length>0){f=b.deferredApplyCalls,g=[];for(d=0,e=f.length;d<e;d++)c=f[d],g.push(c());return g}})}return a.prototype.handleTemplate=function(a,b,c){var d;return d=this,d.templates[b]?(c(d.templates[b]),!0):(resolver.resolve(a,function(a){return c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},a.prototype.buildCreateCall=function(a,b,c,d,e){var f,g,h;return g=this,h=a.tagName.toUpperCase(),f={tag:h,element:a,elementId:b,elementFqn:c,childrenToCreate:d,templates:e},function(a,b,c,d,e){return g.create(a,b,c,d,f,e)}},a.prototype.crawl=function(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p,q,r;return n=this,(b!=null?b.length:void 0)&&(!b.nodeType||b.nodeType===1)?b.length>1?(p=b.length,e=function(){var d,e;e=[];for(l=0,d=p-1;0<=d?l<=d:l>=d;0<=d?l++:l--)e.push([a,b[l],c]);return e}(),q=queueByArgList(n,n.crawl,e),forkJoin(q,function(a){return d(function(b,c,d,e,f){var g;return g=queueByFunctionList(n,a,[b,c,d,e]),forkJoin(g,function(a){return f(a)})})})):n.crawl(a,b[0],c,d):(b!=null?b.nodeType:void 0)&&b.nodeType!==1?d(function(){return arguments[4](b.nodeValue)}):(o=b?o=elementTemplate(b):a,k=b!=null?(r=b.attributes[configuration.elementIdentifier])!=null?r.value:void 0:void 0,j=a+(k?"."+k:""),o?c[o]?d(function(){return n.factories[o].apply(n,[].slice.call(arguments,0))}):(c[o]=o,n.handleTemplate(o,j+"."+o,function(b){return n.crawl(a,b,c,function(a){return n.factories[o]=a,d(a)})})):(h=b.childNodes,g=h.length,i=function(a){var e;return e=n.buildCreateCall(b,k,j,a,c),n.factories[j]=e,d(e)},h.length>0?(e=function(){var a,b,d;d=[];for(a=0,b=h.length;a<b;a++)f=h[a],d.push([j,f,c]);return d}(),m=queueByArgList(n,n.crawl,e),forkJoin(m,i)):i([])))},a.prototype.handleModelTemplate=function(a,b,c,d,e,f,g){var h;return h=this,h.templates[a]?h.templates[a](b,c,d,e,g):h.handleTemplate(a,a,function(i){return h.crawl(f.elementFqn,i,templates,function(f){return h.templates[a]=f,f(b,c,d,e,g)})})},a.prototype.create=function(a,b,c,d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;t=this,l=e.elementId,d=l||d,n=l!==void 0&&l!=="",m=n?d:"",s=createFqn(c,m,!1,t.name);if(n&&!b[d]){f("");return}return r=getActualValue(b.__template__,b),p=getActualValue((u=b[d])!=null?u.__template__:void 0,b),q=getActualValue(getNestedValue(b[d],"__value__")||b[d]||getNestedValue(b,"__value__"),b),i=n?b[d]:b,r?(delete b.__template__,t.handleModelTemplate(r,a,b,c,d,e,function(c){return f(t.makeTag(e.tag,e.element,s,d,n,c,b,a))})):p?(delete b[d].__template__,t.handleModelTemplate(r,a,b,c,d,e,f)):(h=e!=null?e.childrenToCreate.slice(0):void 0,g=h.length,g>0?(j=getNestedValue(q,"__items__")||q,k=j?j.length:0,o=k&&!_.isString(j)?j:void 0,t.factories[s+"_add"]=function(b,c,d){return s=""+s+"."+b,createChildren(0,a,c,s,b,e,d)},o?createChildren(k,a,i,s,void 0,e,function(c){return f(t.makeTag(e.tag,e.element,s,d,e.elementId,c,b,a))}):createChildren(0,a,i,s,d,e,function(c){return f(t.makeTag(e.tag,e.element,s,d,e.elementId,c,b,a))})):f(t.makeTag(e.tag,e.element,s,d,n,q,b,a)))},a.prototype.makeTag=function(a,b,c,d,e,f,g,h){var i,j,k,l,m;l=this,k={},i=_.isString(f)?f:_.isArray(f)?f||(f!=null?f[d]:void 0):(f!=null?f[d]:void 0)||f,i=b.children.length===0&&d===void 0&&(_.isObject(f)||_.isArray(f))?b.textContent:i,j={},e&&(k[configuration.elementIdentifier]=c),b.className&&(k["class"]=b.className),b.type&&(k.type=b.type),b.value&&(k.value=b.value),b.id&&(k.id=b.id);if(g!=null?(m=g[d])!=null?m["class"]:void 0:void 0)k["class"]=g[d]["class"];return a==="INPUT"?(_.isObject(i)||(k.value=i),j=l.html[a](k)):a==="IMG"?(k=$.extend(k,{src:i.src||i||b.src,alt:i.alt||i||b.alt,width:i.width||b.width||"",height:i.height||b.height||""}),j=l.html[a](k)):a==="A"?(k=$.extend(k,{href:g.link||b.href,alt:g.alt||i||b.alt}),j=l.html[a](k,i)):j=l.html[a](k,i),j},a.prototype.apply=function(a,b,c){var d,e;return e=this,d=$.extend(!0,{},b),e.ready?e.render(a,d,a,void 0,function(b){var d;return d={},b.length?d=getHtmlFromList(b,e.html):(d=$(b)[0],$(d).attr(configuration.elementIdentifier,a)),c(a,d,"render")}):e.deferredApplyCalls.push(function(){return e.apply(a,d,c)})},a.prototype.update=function(a,b,c){var d,e,f,g,h;g=this,e=a.lastIndexOf("."),h=a.split(".")[0],f=a.substring(0,e),d=a.substring(e+1);if(g.factories[a])return g.factories[a](h,b,f,d,function(b){var d;return d=b,c(a,d,"update")})},a.prototype.add=function(a,b,c){var d,e,f,g,h,i,j;i=this,g=a.lastIndexOf("."),j=a.split(".")[0],h=a.substring(0,g),e=a.substring(g+1),d=a+"_add";if(i.factories[d])return f=$("["+configuration.elementIdentifier+'="'+a+'"]').children.length+1,i.factories[d](f,b,function(b){var d;return d=getHtmlFromList(b,i.html),c(a,d,"add")})},a}()