(function(a){var b,c;b=function(){var a,b,c;return b=this,c=[],a=function(a){var b;return b=$("#"+a+"-template > :only-child"),b.length>0?b[0]:null},this.addSource=function(a){return c.push(a)},this.resolve=function(b,d,e){var f,g,h;return h=a(b),h?d(h):(g=0,f=function(){},f=function(){return c[g].resolve(b,function(a){return d($(a)[0],function(){return g++,f()})})},f())},infuser&&b.addSource({resolve:function(a,b,c){return infuser.get(a,function(a){return b(a)},c)}}),b},c=new b;var d;d=function(){var a;return a=this,postal.channel("cartographer").subscribe(function(b){if(b.map)return a.map(b.name,b.namespace);if(b.apply)return a.apply(b.template,b.proxy,b.render,b.error);if(b.addSource)return a.resolver.addSource(b.provider)}),this.templates={},this.map=function(b,c,d){var f;return f=new e(b,c,d),a.templates[b]=f},this.apply=function(b,c,d,e){var f;return b=b||(b=c.__template__),f=a.templates[b],f?f.apply(c,function(a){return d?d(a,f.target,f.fqn):$("#"+f.target).fadeOut(200,function(){return $(this).html(a).fadeIn(300)})}):(a.map(b,c.getPath()),a.apply(b,c))},this.resolver=c,a},a.cartographer=new d;var e;e=function(a,b,d){var e,f,g,h,i,j,k,l,m,n,o;l=this;var p,q,r,s;return p={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},q={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},r={hide:"hidden",title:"title",value:"value","class":"className"},s={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"},e=function(a,b,c,d){var e,f,g,h,i;if(a&&b){e=a[c];if(e!==void 0){if(_.isArray(d)){i=[];for(g=0,h=d.length;g<h;g++)f=d[g],i.push(b[f]=e);return i}return b[d]=e}}},f=function(a,b,c){var d,f,g,h,i;h=_.keys(c),i=[];for(f=0,g=h.length;f<g;f++)d=h[f],i.push(e(a,b,d,c[d]));return i},g=function(a,b,d,e,f){var g,i,j,l;return j=h(d,e!=null?e.id:void 0),i="",g=!0,j!==d&&((l=b[j])!=null?l.__template__:void 0)?i=b[j].__template__:(g=!1,i=d),!e||g?c.resolve(i,function(c){return e=c,e.nested=!0,k(a,b,d,e,f)}):k(a,b,d,e,f)},k=function(a,b,c,d,e){var f,i,k,l,m,n,o,p,q,r,s;m=d.id,l=h(c,m),o=d.tagName.toUpperCase(),a=a||b;if(d.children!==void 0&&d.children.length>0){k=[],n=function(c){var f;k.push(c);if(k.length===d.children.length)return f=function(c,e,f,g){var i,l,n,p,q,r,s,t,u,v,w;i=m===""?g:m,u=h(f,i),v=i===u||i===void 0?e:e!=null?e[i]:void 0,v.value&&(v=v.value),q=v.length?v:v!=null?v.items:void 0;if(q&&q.length){t=[],p=k[0],a.template[u+"_add"]=function(a,b){return p(c,b,u,a)};for(s=0,w=q.length-1;0<=w?s<=w:s>=w;0<=w?s++:s--)t.push(function(){var a,b,d;d=[];for(a=0,b=k.length;a<b;a++)l=k[a],d.push(l(c,q,u,s));return d}());return n=j(a,c,o,d,u,i,t,b,e),a[u]=n,n}return r=function(){var a,b,d;d=[];for(a=0,b=k.length;a<b;a++)l=k[a],d.push(l(c,v,u));return d}(),n=j(a,c,o,d,u,i,r,b,e),a[u]=n,n},a.template[l]=f,e(f)},r=d.children,s=[];for(p=0,q=r.length;p<q;p++)i=r[p],s.push(g(a,b,l,i,function(a){return n(a)}));return s}return f=function(c,e,f,g){var i,k,n,p;return i=m===""?g:m,n=h(f,i),p=i===l?e:e!=null?e[i]:void 0,k=j(a,c,o,d,n,i,p,b,e),a[n]=k,k},a.template[l]=f,e(f)},h=function(a,b){var c;return b===void 0||b===""?c=a:a===void 0||a===""?c=b:a===b?c=b:c=""+a+"."+b,c},j=function(a,b,c,d,e,g,h,i,j){var k,l,n,o;n={},o=d.textContent?d.textContent:d.value,k=h?h:o,l={};if(g||g===0)n.id=g;d&&f(d,n,s),c==="INPUT"?(_.isObject(k)||(n.value=k),l=b[c](n)):l=b[c](n,k);if(j!=null?j[g]:void 0)h instanceof Array?f(j[g],l,r):f(j[g],l,q);return m(j!=null?j[g]:void 0,i,e,l,a),l},m=function(a,b,c,d,e){var f,g,h,i,j;if(a){i=_.keys(p),j=[];for(g=0,h=i.length;g<h;g++)f=i[g],j.push(o(f,p[f],a,b,c,d,e));return j}},i=function(a){var b,c,f,g,h,i,j,k;if(a.event!=="read"){g=l[a.key],h=a.key.lastIndexOf("."),j=a.key.substring(0,h),f=a.key.substring(h+1),d="value",b=a.key;if(f==="value"||!g)g=l[j],d=f,b=j;if(a.event==="wrote")return f==="__template__"?cartographer.apply(a.info.value,a.parent):g&&l.template[b]&&a.info.value&&a.info.value.isProxy?(k=a.info.value.getRoot?a.info.value.getRoot():a.info.value,$(l[b]).replaceWith(l.template[b](l.html,k,j))):e(a.info,g,"value",q[d]);if(a.event==="added"){c=j+"_add";if(l.template[c])return i=l.template[c](f,a.parent),$(l[j]).append(i)}}},n=function(a,b){return l.changeSubscription!==void 0&&l.changeSubscription.unsubscribe(),l.changeSubscription=postal.channel(b).subscribe(i)},o=function(a,b,c,d,e,f,g){var h,i;return h=c[a],h?(i=function(a){return h.apply(c,[d,{id:e,control:g[e],event:b,context:g,info:a}])},f[b]=i):f[b]=function(a){return b==="onchange"&&a.stopPropagation(),g.eventChannel.publish({id:e,model:c,control:g[e],event:b,context:g,info:a})}},this.apply=function(a,c){return g(l,a,b,l.element,function(b){return c(b(l.html,a))})},this.name=a,this.namespace=b,this.fqn="",this.element=void 0,this.eventChannel=postal.channel(b+"_events"),this.html=DOMBuilder.dom,this.template={},this.changeSubscription=void 0,this.target=d||(d=b),c.resolve(a,function(a){return l.element=a}),n(l,b+"_model"),l}})(window)