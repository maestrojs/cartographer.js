(function(a){var b,c;b=function(){var a,b,c,d;return c=this,d=[],a=function(a){var b;return b=$("#"+a),b?b[0]:null},b=function(a){var b;return b=_.find(d,function(b){return b.resolve(a)}),$(b)[0]},this.addSource=function(a){return d.push(a)},this.resolve=function(c){var d;return d=a(c),d||(d=b(c))},c},c=new b;var d;d=function(){var a;return a=this,postal.channel("cartographer").subscribe(function(b){if(b.map)return a.map(b.name,b.namespace);if(b.apply)return a.apply(b.template,b.proxy,b.render,b.error)}),this.templates={},this.map=function(a,b){var c;return c=new e(a,b),this.templates[a]=c},this.apply=function(a,b,c,d){var e,f;a=a||(a=b.__template__),f=this.templates[a];if(f)return e=f.apply(b),c?c(e,f.fqn):$("#"+f.name).replaceWith(e);if(d)return d()},a},a.cartographer=new d;var e;e=function(a,b){var d,e,f,g,h,i,j,k,l,m;j=this;var n,o,p,q;return n={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},o={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},p={hide:"hidden",title:"title",value:"value","class":"className"},q={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"},d=function(a,b,c,d){var e,f,g,h,i;if(a&&b){e=a[c];if(e!==void 0){if(_.isArray(d)){i=[];for(g=0,h=d.length;g<h;g++)f=d[g],i.push(b[f]=e);return i}return b[d]=e}}},e=function(a,b,c){var e,f,g,h,i;h=_.keys(c),i=[];for(f=0,g=h.length;f<g;f++)e=h[f],i.push(d(a,b,e,c[e]));return i},f=function(a,b,c,d){var e,h,j,k,l,m;return l=d.id,k=g(c,l),m=d.tagName.toUpperCase(),a=a||b,d.children!==void 0&&d.children.length>0?(j=function(){var c,e,g,i;g=d.children,i=[];for(c=0,e=g.length;c<e;c++)h=g[c],i.push(f(a,b,k,h));return i}(),e=function(c,e,f,h){var k,n,o,p,q,r,s,t,u,v,w;k=l===""?h:l,u=g(f,k),v=k===u||k===void 0?e:e!=null?e[k]:void 0,q=v.length?v:v!=null?v.items:void 0;if(q&&q.length){t=[],p=j[0],a.template[u+"_add"]=function(a,b){return p(c,b,u,a)};for(s=0,w=q.length-1;0<=w?s<=w:s>=w;0<=w?s++:s--)t.push(function(){var a,b,d;d=[];for(a=0,b=j.length;a<b;a++)n=j[a],d.push(n(c,q,u,s));return d}());return o=i(a,c,m,d,u,k,t,b,e),a[u]=o,o}return r=function(){var a,b,d;d=[];for(a=0,b=j.length;a<b;a++)n=j[a],d.push(n(c,v,u));return d}(),o=i(a,c,m,d,u,k,r,b,e),a[u]=o,o},a.template[k]=e,e):(e=function(c,e,f,h){var j,n,o,p;return j=l===""?h:l,o=g(f,j),p=j===k?e:e!=null?e[j]:void 0,n=i(a,c,m,d,o,j,p,b,e),a[o]=n,n},a.template[k]=e,e)},g=function(a,b){var c;return b===void 0||b===""?c=a:a===void 0||a===""?c=b:a===b?c=b:c=""+a+"."+b,c},i=function(a,b,c,d,f,g,h,i,j){var l,m,n,r;n={},r=d.textContent?d.textContent:d.value,l=h?h:r,m={};if(g||g===0)n.id=g;d&&e(d,n,q),c==="INPUT"?(_.isObject(l)||(n.value=l),m=b[c](n)):m=b[c](n,l);if(j!=null?j[g]:void 0)h instanceof Array?e(j[g],m,p):e(j[g],m,o);return k(j!=null?j[g]:void 0,i,f,m,a),m},k=function(a,b,c,d,e){var f,g,h,i,j;if(a){i=_.keys(n),j=[];for(g=0,h=i.length;g<h;g++)f=i[g],j.push(m(f,n[f],a,b,c,d,e));return j}},h=function(a){var b,c,e,f,g,h,i,k,l;if(a.event!=="read"){f=j[a.key],g=a.key.lastIndexOf("."),i=a.key.substring(0,g),e=a.key.substring(g+1),k="value",b=a.key;if(e==="value"||!f)f=j[i],k=e,b=i;if(a.event==="wrote")return f&&j.template[b]&&a.info.value&&a.info.value.isProxy?(l=a.info.value.getRoot?a.info.value.getRoot():a.info.value,$(j[b]).replaceWith(j.template[b](j.html,l,i))):d(a.info,f,"value",o[k]);if(a.event==="added")return c=i+"_add",h=j.template[c](e,a.parent),$(j[i]).append(h)}},l=function(a,b){return j.changeSubscription!==void 0&&j.changeSubscription.unsubscribe(),j.changeSubscription=postal.channel(b).subscribe(h)},m=function(a,b,c,d,e,f,g){var h,i;return h=c[a],h?(i=function(a){return h.apply(c,[d,{id:e,control:g[e],event:b,context:g,info:a}])},f[b]=i):f[b]=function(a){return b==="onchange"&&a.stopPropagation(),g.eventChannel.publish({id:e,model:c,control:g[e],event:b,context:g,info:a})}},this.apply=function(a){var c;return c=f(this,a,b,this.element,this.apply),console.log("applying to "+b),l(j,b+"_model"),c(this.html,a)},this.name=a,this.namespace=b,this.fqn="",this.element=c.resolve(a),this.eventChannel=postal.channel(b+"_events"),this.html=DOMBuilder.dom,this.template={},this.changeSubscription=void 0,l(j,b+"_model"),this}})(window)