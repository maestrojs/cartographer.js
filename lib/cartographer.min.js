/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
var configuration;configuration={elementIdentifier:"data-id",templateIdentifier:"data-template"};var SourceResolver,infuser,resolver;SourceResolver=function(){var a,b;return a=this,b=[],this.appendSource=function(a){return b.push(a)},this.prependSource=function(a){return b.unshift(a)},this.resolve=function(a,c,d){var e,f;return f=0,e=function(){},e=function(){var g;return g=b[f],g?g(a,function(a){return c($(a)[0])},function(){return f++,e()}):d()},e()},a},resolver=new SourceResolver,resolver.appendSource(function(a,b,c){var d;return d=$("#"+a+"-template"),d.length>0?b(d[0]):c()}),infuser=infuser||window.infuser,infuser&&resolver.appendSource(function(a,b,c){return infuser.get(a,function(a){return b(a)},function(a){return c()})});var Cartographer,cartographer;Cartographer=function(){var a;return a=this,this.config=configuration,this.templates={},this.containerLookup={},this.instanceCache={},this.map=function(b){var c;return c=new Template(b),a.templates[b]=c,!0},this.apply=function(b,c,d,e,f){var g,h;return this.containerLookup[c]=a.templates[b],a.templates[b]?(g=a.templates[b],g.apply(c,d,function(b,c,d){return a.instanceCache[b]=d,e(b,c,d)})):d.__template__&&c?(h=d.__template__,a.map(h),a.apply(h,c,d,e,f)):f(c,"render","No template with "+b+" has been mapped")},this.add=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.add(c,d,e)},this.update=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.update(c,d,e)},this.watchEvent=function(b,c,d){var e;if(a.containerLookup[b])return e=a.containerLookup[b],e.watchEvent(b,c,d)},this.ignoreEvent=function(b,c){var d;if(a.containerLookup[b])return d=a.containerLookup[b],d.ignore(b,c)},this.resolver=resolver,a},cartographer=new Cartographer,cartographer;var eventHandlers,modelTargets,modelTargetsForCollections,templateProperties;eventHandlers={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},modelTargets={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},modelTargetsForCollections={hide:"hidden",title:"title",value:"value","class":"className"},templateProperties={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var conditionalCopy,copyProperties,createFqn,externalItemTemplate,externalTemplate,isCurrent,propertyCopy;createFqn=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},conditionalCopy=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},propertyCopy=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(conditionalCopy(b,e,a[c]));return h}return conditionalCopy(b,d,a[c])},copyProperties=function(a,b,c){var d,e,f,g,h;if(a&&b){g=_.keys(c),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],h.push(propertyCopy(a,b,d,c[d]));return h}},isCurrent=function(a,b){return a===b},externalTemplate=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},externalItemTemplate=function(a,b){var c,d;if(_(a[b]).isArray())return(c=a[b])!=null?(d=c[0])!=null?d.__template__:void 0:void 0};var Template;Template=function(a){var b,c,d,e,f,g,h;return g=this,e=function(a,b,c){return g.templates[b]?(c(g.templates[b]),!0):(resolver.resolve(a,function(a){return g.templates[b]=a,c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},d=function(a){var b;return a!=null?(b=a.attributes[configuration.templateIdentifier])!=null?b.value:void 0:void 0},c=function(a,f,h,i){var j,k,l,m,n,o,p,q,r,s,t,u,v;if((f!=null?f.nodeType:void 0)&&f.nodeType!==1)return i(function(){return f.nodeValue});r=d(f)||(f?void 0:a),q=f!=null?(u=f.attributes[configuration.elementIdentifier])!=null?u.value:void 0:void 0,p=a+(q?"."+q:"");if(r)return e(r,p+"."+r,function(b){return c(a,b,h,i)});m=f.childNodes,l=m.length,o=function(a){var c;return c=b(f,q,p,a,h),g.factories[p]=c,i(c)};if(m.length>0){n=[],j=function(a){n.push(a);if(n.length===l)return o(n)},v=[];for(s=0,t=m.length;s<t;s++)k=m[s],v.push(c(p,k,h,j));return v}return o([])},b=function(a,b,d,h,i){var j;return j=a.tagName.toUpperCase(),function(k,l,m,n){var o,p,q,r,s,t,u,v,w,x,y,z,A;x=n===void 0?b:n,w=createFqn(m,x,!0,g.name),z=(l!=null?l[x]:void 0)||l,y=z.__template__,delete z.__template__,z=(z!=null?z.value:void 0)||z,z=_.isFunction(z)?z.call(l):z;if(y){console.log(""+y),i[w]=!0;if(g.templates[y])return g.templates[y](k,l,m,n);console.log("create element found template: "+y+" and has "+JSON.stringify(i)),o=void 0,e(y,y,function(a){return c(d,a,i,function(a){return g.templates[y]=a,o=a})});while(!o)setTimeout(function(){},0);return o(k,l,m,n)}if(h&&h.length>0){q=(z!=null?z.length:void 0)?z:z!=null?z.items:void 0;if(q&&q.length){v=[],p=h.slice(0),g.factories[w+"_add"]=function(a,b){var c,d,e,f;f=[];for(d=0,e=p.length;d<e;d++)c=p[d],f.push(c(k,b,w,a));return f};for(u=0,A=q.length-1;0<=A?u<=A:u>=A;0<=A?u++:u--)v.push(function(){var a,b,c;c=[];for(a=0,b=h.length;a<b;a++)t=h[a],c.push(t(k,q,w,u,m));return c}());return f(j,a,w,x,b!==void 0,v,l,k)}return r=function(){var a,b,c;c=[];for(a=0,b=h.length;a<b;a++)s=h[a],c.push(s(k,z,w,void 0,m));return c}(),f(j,a,w,x,b!==void 0,r,l,k)}return f(j,a,w,x,b!==void 0,z,l,k)}},f=function(a,b,c,d,e,f,h,i){var j,k,l;l={},j=_.isArray(f)&&!_.isString(f)?f||(f!=null?f[d]:void 0):(f!=null?f[d]:void 0)||f,j=b.children.length===0&&d===void 0?b.textContent:j,k={},e&&(l[configuration.elementIdentifier]=c,console.log(""+a+" - "+c+" - "+d+" - "+f)),b&&copyProperties(b,l,templateProperties),a==="INPUT"?(_.isObject(j)||(l.value=j),k=g.html[a](l)):k=g.html[a](l,j);if(h!=null?h[d]:void 0)f instanceof Array?copyProperties(h[d],k,modelTargetsForCollections):copyProperties(h[d],k,modelTargets);return e&&(g.generated[i][c]=k),k},h=function(a){var b,c,d,e,f;e=g.watching,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(g.watchEvent(a,b.event,b.handler));return f},this.apply=function(a,b,c){var d,e;return d=$.extend(!0,{},b),g.generated[a]={},g.ready?(e=g.render(a,d,a),$(e).attr(configuration.elementIdentifier,a),g.generated[a].top=e,h(a),c(a,"render",e)):g.deferredApplyCalls.push(function(){return g.apply(a,d,c)})},this.watchEvent=function(a,b,c){return g.generated[a].top&&$(g.generated[a].top).on(b,function(a){var b,d;return b=(d=a.target.attributes[configuration.elementIdentifier])!=null?d.value:void 0,c(g.id,b,a.target,a.type)}),g.watching.push({event:b,handler:c}),g.watching=_.uniq(g.watching)},this.ignoreEvent=function(a,b){return g.generated[a].top&&g.generated[a].top.off(eventname),g.watching=_.reject(g.watching,function(a){return a.event===b})},this.update=function(a,b,c){var d,e,f,h,i;e=a.lastIndexOf("."),i=a.split(".")[0],h=a.substring(0,e),d=a.substring(e+1);if(g.factories[a])return f=g.factories[a](i,b,h,d),c(a,"update",f)},this.add=function(a,b,c){var d,e,f,h,i,j,k;h=a.lastIndexOf("."),k=a.split(".")[0],j=a.substring(0,h),e=a.substring(h+1),d=a+"_add";if(g.factories[d])return f=g.generated[k][a].children.length,i=g.factories[d](f,b),c(a,"add",i)},this.name=a,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.generated={},this.changeSubscription=void 0,this.watching=[],this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},c(g.name,void 0,{},function(a){var b,c,d,e,f;g.render=a,g.ready=!0;if(g.deferredApplyCalls.length>0){e=g.deferredApplyCalls,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b());return f}}),g};var PostalSetup,setup;PostalSetup=function(){var a;return a=this,this.apply=function(a){var b,c,d;return c=a.name,d=a.template,b=a.model,cartographer.apply(c,d,b,function(a,b,c){return postal.publish("cartographer","render."+d,{template:d,markup:c,operation:"render"})},function(a){return postal.publish("cartographer","render."+a,{template:d,error:a,operation:"render"})})},this.map=function(a){return cartographer.map(a.name)},this.resolver=function(a){return a.order==="prepend"?cartographer.resolver.prependSource(a.resolver):cartographer.resolver.appendSource(a.resolver)},this.add=function(a){var b,c,d;return d=a.template,b=a.id,c=a.model,cartographer.add(d,b,c,function(a,c,e){return postal.publish("cartographer","render.{templateId}",{template:d,parent:b,markup:e,operation:"add"})})},this.update=function(a){var b,c,d;return d=a.template,b=a.id,c=a.model,cartographer.update(d,b,c,function(a,c,e){return postal.publish("cartographer","render.{templateId}",{template:d,id:b,markup:e,operation:"update"})})},this.watch=function(a){return cartographer.watchEvent(a.template,a.event,function(a,b,c,d){return postal.publish("cartographer."+a,""+b+"."+d,{element:c})})},this.ignore=function(a){return cartographer.ignoreEvent(a.template,a.event)},postal.subscribe("cartographer","api",function(b,c){var d;return d=b.operation,a[d](b)}),postal.subscribe("postal","subscription.*",function(b,c){var d,e,f;if(b.exchange.match(/^cartographer[.]*/)){f=b.exchange.split(".")[1];if(cartographer.templates[f]){e=b.topic.split("."),d={template:f,event:e[e.length-1]};if(c.topic==="subscription.created"&&b.exchange.match(/^cartographer/))return a.watch(d);if(b.exchange.match(/^cartographer/))return a.ignore(d)}}})},setup=new PostalSetup