define(["postal","infuser","DOMBuilder"],function(a,b){var c,d;c=function(){var a,b;return a=this,b=[],this.addSource=function(a){return b.push(a)},this.resolve=function(a,c,d){var e,f;return f=0,e=function(){},e=function(){var g,h;return g=(h=b[f])!=null?h.resolve:void 0,g?g(a,function(a){return c($(a)[0])},function(){return f++,e()}):d()},e()},a},d=new c,d.addSource({resolve:function(a,b,c){var d;return d=$("["+g.elementIdentifier+'="'+a+'-template"]'),d.length>0?b(d[0]):c()}}),b&&d.addSource({resolve:function(a,c,d){return b.get(a,function(a){return c(a)},function(a){return console.log("got "+a),d()})}});var e,f,g;g={elementIdentifier:"map-id"},e=function(){var b;return b=this,this.config=g,this.templates={},this.map=function(a,c,d){var e;return e=new q(a,c,d),b.templates[a]=e,!0},this.apply=function(c,d,e,f){var g;return e=e||function(b){return a.publish("cartographer","render."+c,{id:c,markup:b})},f=f||function(b){return a.publish("cartographer","render.error."+c,b)},b.templates[c]?(g=b.templates[c],g.apply(d,function(a){return e(a)})):d.__template__&&c?(b.map(c,d.__template__,d),b.apply(c,d,e,f)):f("No template with "+c+" has been mapped")},this.resolver=d,b},f=new e,a.subscribe("cartographer","api.*",function(a,b){if(b.topic==="api.map")return f.map(a.id,a.name,a.model);if(b.topic==="api.apply")return f.apply(a.id,a.model);if(b.topic==="api.templateSource")return f.resolver.addSource(a.provider)}),a.subscribe("cartographer","event.*",function(a,b){var c;if(b.topic==="event.watch")return c=f.templates[a.id],c!=null?c.watchEvent(a.event):void 0;if(b.topic==="event.ignore")return c=f.templates[a.id],c!=null?c.ignoreEvent(a.event):void 0}),f;var h,i,j,k;h={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},i={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},j={hide:"hidden",title:"title",value:"value","class":"className"},k={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var l,m,n,o,p;n=function(a,b,c,d){var e,f,g,h;return g=a||"",d&&(g=g===c?"":g),f=b||"",e=g!==""&&f!==""?".":"",h=""+g+e+f,h},l=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(b[e]=a[c]||b[e]);return h}return b[d]=a[c]||b[d]},m=function(a,b,c){var d,e,f,g,h;if(a&&b){g=_.keys(c),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],h.push(l(a,b,d,c[d]));return h}},p=function(a,b){return a===b},o=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0};var q;q=function(b,c,e){var f,h,l,q,r,s,t;return r=this,f=function(a,b,c,e){var f,h,i,j,k;return f=(c!=null?(k=c.attributes[g.elementIdentifier])!=null?k.value:void 0:void 0)||"",i=n(b,f,r.name,!0),h=!c,j=o(a,f)||r.name,!p(i,b)&&o(a,f)||h?d.resolve(j,function(c){return c.nested=!0,q(a,b,c,e)},function(){return console.log("No template could be found for "+j)}):q(a,b,c,e)},q=function(a,b,c,d){var e,h,i,j,k,m,o,p,q,s,t,u,v,w;c||console.log("ELEMENT IS NULL AND SHOULDN'T BE!!!!!!"),k=(c!=null?(t=c.attributes[g.elementIdentifier])!=null?t.value:void 0:void 0)||"",m=n(b,k,!1,r.name),p=c.tagName.toUpperCase(),h=(u=c.children)!=null?u.length:void 0;if(h>0){i=[],o=function(b){var e;i.push(b);if(i.length===h)return e=function(b,d,e){var f,g,h,j,m,o,q,s,t,u,v,w;u=k===""?e:k,t=n(d,u,!1,r.name),v=u===t||u===void 0?b:b[u];if(v!=null?v.value:void 0)v=v.value;h=(v!=null?v.length:void 0)?v:v!=null?v.items:void 0;if(h&&h.length){s=[],g=i[0],r.template[t+"_add"]=function(a,b){return g(b,t,a)};for(q=0,w=h.length-1;0<=w?q<=w:q>=w;0<=w?q++:q--)s.push(function(){var a,b,c;c=[];for(a=0,b=i.length;a<b;a++)o=i[a],c.push(o(h,t,q));return c}());return f=l(p,c,t,u,s,a,b),r[t]=f,f}return j=function(){var a,b,c;c=[];for(a=0,b=i.length;a<b;a++)m=i[a],c.push(m(r.html,v,t));return c}(),f=l(p,c,t,u,j,a,b),r[t]=f,f},r.template[m]=e,d(e)},v=c.children,w=[];for(q=0,s=v.length;q<s;q++)e=v[q],w.push(f(a,m,e,function(a){return o(a)}));return w}return j=function(b,d,e){var f,g,h,i;h=k===""?e:k,g=n(d,h,!0,r.name),i=h===g||h===void 0?b:b[h];if(i!=null?i.value:void 0)i=i.value;return f=l(p,c,g,h,i,a,b),r[g]=f,f},r.template[m]=j,d(j)},l=function(a,b,c,d,e,f,h){var l,n,o,p;o={},p=b.textContent?b.textContent:b.value,l=e?e:p,n={};if(d||d===0)o[g.elementIdentifier]=d;b&&m(b,o,k),a==="INPUT"?(_.isObject(l)||(o.value=l),n=r.html[a](o)):n=r.html[a](o,l);if(h!=null?h[d]:void 0)e instanceof Array?m(h[d],n,j):m(h[d],n,i);return n},h=function(b){var c,d,e,f,g,h,i;e=r[b.key],h=b.operation,f=b.key.lastIndexOf("."),i=b.key.substring(0,f),d=b.key.substring(f+1);if(h==="add"){c=i+"_add";if(r.template[c])return g=r.template[c](b.value,i,d),a.publish("cartographer","markup.added",{operation:"added",parent:i,element:g})}else if(h="change")return r.template[b.key](b.value,i,d,function(b){return a.publish("cartographer","markup.created",{operation:"created",parent:i,element:b})})},s=function(){return r.changeSubscription!==void 0&&r.changeSubscription.unsubscribe(),r.changeSubscription=a.subscribe("cartographer","template."+r.id+".*",h)},t=function(){var a,b,c,d,e;d=r.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(r.watchEvent(a));return e},this.apply=function(a,b){return f(a,"",r.element,function(c){return r.top=c(r.html,a),t(),b(r.top)})},this.watchEvent=function(b){return r.top.on(b,function(b){var c,d;return c=r.id+"."+((d=b.target.attributes[g.elementIdentifier])!=null?d.value:void 0)+"."+b.type,a.publish("cartographer",c,b.target)}),r.watching=_.uniq(r.watching.push(b))},this.ignoreEvent=function(a){return r.top.off(eventname),r.watching=_.reject(r.watching,function(b){return b===a})},this.name=c,this.id=b,this.fqn="",this.element=void 0,this.html=DOMBuilder.dom,this.template={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],d.resolve(c,function(a){return r.element=a},function(){return console.log("No template could be found for "+c)}),s(),r}})