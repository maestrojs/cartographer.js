/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
var configuration;configuration={elementIdentifier:"map-id",templateIdentifier:"template-id"};var SourceResolver,infuser,resolver;SourceResolver=function(){var a,b;return a=this,b=[],this.appendSource=function(a){return b.push(a)},this.prependSource=function(a){return b.unshift(a)},this.resolve=function(a,c,d){var e,f;return f=0,e=function(){},e=function(){var g;return g=b[f],g?g(a,function(a){return c($(a)[0])},function(){return f++,e()}):d()},e()},a},resolver=new SourceResolver,resolver.appendSource(function(a,b,c){var d;return d=$("["+configuration.elementIdentifier+'="'+a+'-template"]'),d.length>0?b(d[0]):c()}),infuser=infuser||window.infuser,infuser&&resolver.appendSource(function(a,b,c){return infuser.get(a,function(a){return b(a)},function(a){return c()})});var Cartographer,cartographer;Cartographer=function(){var a;return a=this,this.config=configuration,this.templates={},this.map=function(b,c){var d;return d=new Template(b,c),a.templates[b]=d,!0},this.apply=function(b,c,d,e){var f;return a.templates[b]?(f=a.templates[b],f.apply(c,function(a,b,c){return d(a,b,c)})):c.__template__&&b?(a.map(b,c.__template__,c),a.apply(b,c,d,e)):e(b,"render","No template with "+b+" has been mapped")},this.resolver=resolver,a},cartographer=new Cartographer,cartographer;var eventHandlers,modelTargets,modelTargetsForCollections,templateProperties;eventHandlers={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},modelTargets={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},modelTargetsForCollections={hide:"hidden",title:"title",value:"value","class":"className"},templateProperties={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var conditionalCopy,copyProperties,createFqn,externalItemTemplate,externalTemplate,isCurrent,propertyCopy;createFqn=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},conditionalCopy=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},propertyCopy=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(conditionalCopy(b,e,a[c]));return h}return conditionalCopy(b,d,a[c])},copyProperties=function(a,b,c){var d,e,f,g,h;if(a&&b){g=_.keys(c),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],h.push(propertyCopy(a,b,d,c[d]));return h}},isCurrent=function(a,b){return a===b},externalTemplate=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},externalItemTemplate=function(a,b){var c,d;if(_(a[b]).isArray())return(c=a[b])!=null?(d=c[0])!=null?d.__template__:void 0:void 0};var Template;Template=function(a,b){var c,d,e,f,g,h,i;return h=this,f=function(a,b,c){return h.templates[b]?(c(h.templates[b]),!0):(resolver.resolve(a,function(a){return h.templates[b]=a,c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},e=function(a){var b;return a!=null?(b=a.attributes[configuration.templateIdentifier])!=null?b.value:void 0:void 0},d=function(a,b,g,i){var j,k,l,m,n,o,p,q,r,s,t,u,v;if((b!=null?b.nodeType:void 0)&&b.nodeType!==1)return i(function(){return b.nodeValue});r=e(b)||(b?void 0:h.name),q=b!=null?(u=b.attributes[configuration.elementIdentifier])!=null?u.value:void 0:void 0,p=a+(q?"."+q:"");if(r)return f(r,p+"."+r,function(b){return d(a,b,g,i)});m=b.childNodes,l=m.length,o=function(a){var d;return d=c(b,q,p,a,g),h.factories[p]=d,i(d)};if(m.length>0){n=[],j=function(a){n.push(a);if(n.length===l)return o(n)},v=[];for(s=0,t=m.length;s<t;s++)k=m[s],v.push(d(p,k,g,j));return v}return o([])},c=function(a,b,c,e,i){var j;return j=a.tagName.toUpperCase(),function(k,l,m){var n,o,p,q,r,s,t,u,v,w,x,y;v=m===void 0?b:m,u=createFqn(l,v,!0,h.name),x=v===void 0?k:k!=null?k[v]:void 0,x=(x!=null?x.value:void 0)||x,w=x!=null?x.__template__:void 0;if(w&&!i[u])return i[u]=!0,f(w,w,function(a){return d(c,a,i,function(a){return a(k,l,m)})});if(e&&e.length>0){o=(x!=null?x.length:void 0)?x:x!=null?x.items:void 0;if(o&&o.length){t=[],n=e.slice(0),h.factories[u+"_add"]=function(a,b){var c,d,e,f;f=[];for(d=0,e=n.length;d<e;d++)c=n[d],f.push(c(b,u,a));return f};for(s=0,y=o.length-1;0<=y?s<=y:s>=y;0<=y?s++:s--)t.push(function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)r=e[a],c.push(r(o,u,s));return c}());return g(j,a,u,v,b!==void 0,t,k)}return p=function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)q=e[a],c.push(q(x,u));return c}(),g(j,a,u,v,b!==void 0,p,k)}return g(j,a,u,v,b!==void 0,x,k)}},g=function(a,b,c,d,e,f,g){var i,j,k;k={},i=_.isArray(f)&&!_.isString(f)?f||(f!=null?f[d]:void 0):(f!=null?f[d]:void 0)||f,i=b.children.length===0&&d===void 0?b.textContent:i,j={},e&&(k[configuration.elementIdentifier]=c),b&&copyProperties(b,k,templateProperties),a==="INPUT"?(_.isObject(i)||(k.value=i),j=h.html[a](k)):j=h.html[a](k,i);if(g!=null?g[d]:void 0)f instanceof Array?copyProperties(g[d],j,modelTargetsForCollections):copyProperties(g[d],j,modelTargets);return e&&(h[c]=j),j},i=function(){var a,b,c,d,e;d=h.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(h.watchEvent(a.event,a.handler));return e},this.apply=function(a,b){return h.ready?(h.top=h.render(a,h.id),$(h.top).attr(configuration.elementIdentifier,h.id),i(),b(h.id,"render",h.top)):h.deferredApplyCalls.push(function(){return h.apply(a,b)})},this.watchEvent=function(a,b){return h.top&&$(h.top).on(a,function(a){var c,d;return c=(d=a.target.attributes[configuration.elementIdentifier])!=null?d.value:void 0,b(h.id,c,a.target,a.type)}),h.watching.push({event:a,handler:b}),h.watching=_.uniq(h.watching)},this.ignoreEvent=function(a){return h.top&&h.top.off(eventname),h.watching=_.reject(h.watching,function(b){return b.event===a})},this.update=function(a,b,c){var d,e,f,g;e=a.lastIndexOf("."),g=a.substring(0,e),d=a.substring(e+1);if(h.factories[a])return f=h.factories[a](b,g,d),c(a,"update",f)},this.add=function(a,b,c){var d,e,f,g,i,j;g=a.lastIndexOf("."),j=a.substring(0,g),e=a.substring(g+1),d=a+"_add";if(h.factories[d])return f=h[a].children.length,i=h.factories[d](f,b),c(a,"add",i)},this.name=b,this.id=a,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},d(h.id,void 0,{},function(a){var b,c,d,e,f;h.render=a,h.ready=!0;if(h.deferredApplyCalls.length>0){e=h.deferredApplyCalls,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b());return f}}),h};var PostalSetup,setup;PostalSetup=function(){var a;return a=this,this.apply=function(a){var b,c;return c=a.template,b=a.model,cartographer.apply(c,b,function(a,b,d){return postal.publish("cartographer","render."+c,{template:c,markup:d,operation:"render"})},function(a){return postal.publish("cartographer","render."+a,{template:c,error:a,operation:"render"})})},this.map=function(a){return cartographer.map(a.template,a.name)},this.resolver=function(a){return a.order==="prepend"?cartographer.resolver.prependSource(a.resolver):cartographer.resolver.appendSource(a.resolver)},this.add=function(a){var b,c,d,e;return e=a.template,b=a.id,c=a.model,d=cartographer.templates[e],d.add(b,c,function(a,c,d){return postal.publish("cartographer","render.{templateId}",{template:e,parent:b,markup:d,operation:"add"})})},this.update=function(a){var b,c,d,e;return e=a.template,b=a.id,c=a.model,d=cartographer.templates[e],d.update(b,c,function(a,c,d){return postal.publish("cartographer","render.{templateId}",{template:e,id:b,markup:d,operation:"update"})})},this.watch=function(a){var b;return b=cartographer.templates[a.template],b.watchEvent(a.event,function(a,b,c,d){return postal.publish("cartographer."+a,""+b+"."+d,{element:c})})},this.ignore=function(a){var b;return b=cartographer.templates[a.template],b.ignoreEvent(a.event)},postal.subscribe("cartographer","api",function(b,c){var d;return d=b.operation,a[d](b)}),postal.subscribe("postal","subscription.*",function(b,c){var d,e,f;if(b.exchange.match(/^cartographer[.]*/)){f=b.exchange.split(".")[1];if(cartographer.templates[f]){e=b.topic.split("."),d={template:f,event:e[e.length-1]};if(c.topic==="subscription.created"&&b.exchange.match(/^cartographer/))return a.watch(d);if(b.exchange.match(/^cartographer/))return a.ignore(d)}}})},setup=new PostalSetup