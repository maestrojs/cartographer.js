/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
var configuration;configuration={elementIdentifier:"map-id"};var SourceResolver,infuser,resolver;SourceResolver=function(){var a,b;return a=this,b=[],this.appendSource=function(a){return b.push(a)},this.prependSource=function(a){return b.unshift(a)},this.resolve=function(a,c,d){var e,f;return f=0,e=function(){},e=function(){var g;return g=b[f],g?g(a,function(a){return c($(a)[0])},function(){return f++,e()}):d()},e()},a},resolver=new SourceResolver,resolver.appendSource(function(a,b,c){var d;return d=$("["+configuration.elementIdentifier+'="'+a+'-template"]'),d.length>0?b(d[0]):c()}),infuser=infuser||window.infuser,infuser&&resolver.appendSource(function(a,b,c){return infuser.get(a,function(a){return b(a)},function(a){return console.log("got "+a),c()})});var Cartographer,cartographer;Cartographer=function(){var a;return a=this,this.config=configuration,this.templates={},this.map=function(b,c){var d;return d=new Template(b,c),a.templates[b]=d,!0},this.apply=function(b,c,d,e){var f;return d=d||function(a){return postal.publish("cartographer","render."+b,{id:b,markup:a})},e=e||function(a){return postal.publish("cartographer","render."+b+".error",a)},a.templates[b]?(f=a.templates[b],f.apply(c,function(a){return d(a)})):c.__template__&&b?(a.map(b,c.__template__,c),a.apply(b,c,d,e)):e("No template with "+b+" has been mapped")},this.resolver=resolver,a},cartographer=new Cartographer,postal.subscribe("cartographer","api.*",function(a,b){if(b.topic==="api.map")return cartographer.map(a.id,a.name);if(b.topic==="api.apply")return cartographer.apply(a.id,a.model);if(b.topic==="api.prepend.resolver")return cartographer.resolver.prependSource(a.resolver);if(b.topic==="api.append.resolver")return cartographer.resolver.appendSource(a.resolver)}),postal.subscribe("cartographer","event.*",function(a,b){var c;if(b.topic==="event.watch")return c=cartographer.templates[a.id],c!=null?c.watchEvent(a.event):void 0;if(b.topic==="event.ignore")return c=cartographer.templates[a.id],c!=null?c.ignoreEvent(a.event):void 0}),postal.subscribe("postal","subscription.*",function(a,b){var c,d,e;if(b.topic==="subscription.created"&&a.exchange.match(/^cartographer[.].+/)){e=a.exchange.split(".")[1],d=cartographer.templates[e];if(d)return c=a.topic.split("."),d.watchEvent(c[c.length-1])}else if(a.exchange.match(/^cartographer[.]*/)){e=a.exchange.split(".")[1],d=cartographer.templates[e];if(d)return c=a.topic.split("."),d.ignoreEvent(c[c.length-1])}}),cartographer;var eventHandlers,modelTargets,modelTargetsForCollections,templateProperties;eventHandlers={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},modelTargets={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},modelTargetsForCollections={hide:"hidden",title:"title",value:"value","class":"className"},templateProperties={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var conditionalCopy,copyProperties,createFqn,externalItemTemplate,externalTemplate,isCurrent,propertyCopy;createFqn=function(a,b,c,d){var e,f,g,h;g=a||"";if(d){if(a===""&&b===c)return"";g=g===c?"":g}return f=b||"",e=g!==""&&f!==""?".":"",h=""+g+e+f,h},conditionalCopy=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},propertyCopy=function(a,b,c,d){var e,f,g,h;if(_.isArray(d)){h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(conditionalCopy(b,e,a[c]));return h}return conditionalCopy(b,d,a[c])},copyProperties=function(a,b,c){var d,e,f,g,h;if(a&&b){g=_.keys(c),h=[];for(e=0,f=g.length;e<f;e++)d=g[e],h.push(propertyCopy(a,b,d,c[d]));return h}},isCurrent=function(a,b){return a===b},externalTemplate=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},externalItemTemplate=function(a,b){var c,d;if(_(a[b]).isArray())return(c=a[b])!=null?(d=c[0])!=null?d.__template__:void 0:void 0};var Template;Template=function(a,b){var c,d,e,f,g,h,i,j;return h=this,d=function(a,b,c,d,e){var f,i,j,k,l,m;return f=(c!=null?(m=c.attributes[configuration.elementIdentifier])!=null?m.value:void 0:void 0)||"",f=f===h.name?"":f,j=createFqn(b,f,h.name,!0),i=!c,k=externalTemplate(a,f)||h.name,l=!e[b+"."+j],l&&!isCurrent(j,b)&&externalTemplate(a,f)||i?resolver.resolve(k,function(c){return e[b+"."+j]=!0,g(a,b,c,d,e)},function(){return console.log("No template could be found for "+k)}):g(a,b,c,d,e)},c=function(a,b,c,d,e){var g;return g=function(g,i,j){var k,l,m,n,o,p,q,r,s,t,u,v;t=c===""?j:c,s=createFqn(i,t,!0,h.name),u=(t===s||t===void 0?g:g[t])||g;if(u!=null?u.value:void 0)u=u.value;m=(u!=null?u.length:void 0)?u:u!=null?u.items:void 0;if(m&&m.length){r=[],l=e[0],h.template[s+"_add"]=function(a,b){return l(b,s,a)};for(q=0,v=m.length-1;0<=v?q<=v:q>=v;0<=v?q++:q--)r.push(function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)p=e[a],c.push(p(m,s,q));return c}());return k=f(a,b,s,t,r,d,g),h[s]=k,k}return n=function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)o=e[a],c.push(o(u,s));return c}(),k=f(a,b,s,t,n,d,g),h[s]=k,k}},g=function(a,b,e,g,i){var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y;e||console.log("ELEMENT IS NULL AND SHOULDN'T BE!!!!!!"),o=(e!=null?(v=e.attributes[configuration.elementIdentifier])!=null?v.value:void 0:void 0)||"",p=createFqn(b,o,!0,h.name),r=e.tagName.toUpperCase(),s=externalItemTemplate(a,o);if(s&&!i[b+"."+o])return resolver.resolve(s,function(f){var j,k,l,m,n,q,s,t,u;i[b+"."+o]=!0,l=f.length>1?f:[f],m=l.length;if(m>0){n=[],q=function(b){var d;n.push(b);if(n.length===m)return d=c(r,e,o,a,n),h.template[p]=d,g(d)},k=function(a){return q(a)},u=[];for(s=0,t=l.length;s<t;s++)j=l[s],u.push(d(a,p,j,k,i));return u}},function(){return console.log("No template could be found for "+s)});l=(w=e.children)!=null?w.length:void 0;if(l>0){m=[],q=function(b){var d;m.push(b);if(m.length===l)return d=c(r,e,o,a,m),h.template[p]=d,g(d)},k=function(a){return q(a)},x=e.children,y=[];for(t=0,u=x.length;t<u;t++)j=x[t],y.push(d(a,p,j,k,i));return y}return n=function(b,c,d){var g,i,j,k;j=o===""?d:o,i=createFqn(c,j,!0,h.name),k=j===i||j===void 0?b:b[j];if(k!=null?k.value:void 0)k=k.value;return g=f(r,e,i,j,k,a,b),h[i]=g,g},h.template[p]=n,g(n)},f=function(a,b,c,d,e,f,g){var i,j,k,l;k={},l=b.textContent?b.textContent:b.value,i=(e!=null?e[d]:void 0)||e&&d||b.children.length>1?e||(e!=null?e[d]:void 0):l,j={};if(d||d===0)k[configuration.elementIdentifier]=d;b&&copyProperties(b,k,templateProperties),a==="INPUT"?(_.isObject(i)||(k.value=i),j=h.html[a](k)):j=h.html[a](k,i);if(g!=null?g[d]:void 0)e instanceof Array?copyProperties(g[d],j,modelTargetsForCollections):copyProperties(g[d],j,modelTargets);return j},e=function(a){var b,c,d,e,f,g,i;d=h[a.key],g=a.operation,e=a.key.lastIndexOf("."),i=a.key.substring(0,e),c=a.key.substring(e+1);if(g==="add"){b=a.key+"_add";if(h.template[b])return f=h.template[b](a.value,i,c),postal.publish("cartographer","markup.added",{operation:"added",parent:i,markup:f})}else if(g="change")return h.template[a.key](a.value,i,c,function(a){return postal.publish("cartographer","markup.created",{operation:"created",parent:i,markup:a})})},i=function(){return h.changeSubscription!==void 0&&h.changeSubscription.unsubscribe(),h.changeSubscription=postal.subscribe("cartographer","template."+h.id+".*",e)},j=function(){var a,b,c,d,e;d=h.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(h.watchEvent(a));return e},this.apply=function(a,b){return d(a,"",h.element,function(c){return h.top=c(a,""),j(),b(h.top)},{})},this.watchEvent=function(a){return h.top&&$(h.top).on(a,function(a){var b,c;return b=((c=a.target.attributes[configuration.elementIdentifier])!=null?c.value:void 0)+"."+a.type,postal.publish("cartographer."+h.id,b,a.target)}),h.watching.push(a),h.watching=_.uniq(h.watching)},this.ignoreEvent=function(a){return h.top.off(eventname),h.watching=_.reject(h.watching,function(b){return b===a})},this.name=b,this.id=a,this.fqn="",this.element=void 0,this.html=DOMBuilder.dom,this.template={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],resolver.resolve(b,function(a){return h.element=a},function(){return console.log("No template could be found for "+b)}),i(),h}