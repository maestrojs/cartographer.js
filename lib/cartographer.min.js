(function(a){var b,c;b=function(){var a,b,c;return b=this,c=[],a=function(a){var b,c;return c=$("#"+a+"-template > :only-child"),b=$("#"+a),c.length>0?c[0]:b.length>0&&b[0].children.length>1?b[0]:null},this.addSource=function(a){return c.push(a)},this.resolve=function(b,d,e){var f,g,h;return h=a(b),h?d(h):(g=0,f=function(){},f=function(){return c[g].resolve(b,function(a){return d($(a)[0],function(){return g++,f()})})},f())},b},c=new b;var d;d=function(){var a;return a=this,postal.channel("cartographer").subscribe(function(b){if(b.map)return a.map(b.name,b.namespace);if(b.apply)return a.apply(b.template,b.proxy,b.render,b.error);if(b.addSource)return a.resolver.addSource(b.provider)}),this.templates={},this.map=function(a,b){var c;return c=new e(a,b),this.templates[a]=c},this.apply=function(a,b,c,d){var e;a=a||(a=b.__template__),e=this.templates[a];if(e)return e.apply(b,function(a){return c?c(a,e.fqn):$("#"+e.name).replaceWith(a)});if(d)return d()},this.resolver=c,a},a.cartographer=new d;var e;e=function(a,b){var d,e,f,g,h,i,j,k,l,m,n;k=this;var o,p,q,r;return o={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},p={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},q={hide:"hidden",title:"title",value:"value","class":"className"},r={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"},d=function(a,b,c,d){var e,f,g,h,i;if(a&&b){e=a[c];if(e!==void 0){if(_.isArray(d)){i=[];for(g=0,h=d.length;g<h;g++)f=d[g],i.push(b[f]=e);return i}return b[d]=e}}},e=function(a,b,c){var e,f,g,h,i;h=_.keys(c),i=[];for(f=0,g=h.length;f<g;f++)e=h[f],i.push(d(a,b,e,c[e]));return i},f=function(a,b,d,e,f){var h,i;return h=g(d,e!=null?e.id:void 0),((i=b[h])!=null?i.__template__:void 0)&&e&&e.id&&!e.nested?c.resolve(b[h].__template__,function(c){return e=c,console.log("*** "+d+" - "+e.id+" - "+e.tagName+" ***"),e.nested=!0,j(a,b,d,e,f)}):j(a,b,d,e,f)},j=function(a,b,c,d,e){var h,j,k,l,m,n,o,p,q,r,s;m=d.id,l=g(c,m),o=d.tagName.toUpperCase(),a=a||b;if(d.children!==void 0&&d.children.length>0){k=[],n=function(c){var f;k.push(c);if(k.length===d.children.length)return f=function(c,e,f,h){var j,l,n,p,q,r,s,t,u,v,w;j=m===""?h:m,u=g(f,j),v=j===u||j===void 0?e:e!=null?e[j]:void 0,v.value&&(v=v.value),q=v.length?v:v!=null?v.items:void 0;if(q&&q.length){t=[],p=k[0],a.template[u+"_add"]=function(a,b){return p(c,b,u,a)};for(s=0,w=q.length-1;0<=w?s<=w:s>=w;0<=w?s++:s--)t.push(function(){var a,b,d;d=[];for(a=0,b=k.length;a<b;a++)l=k[a],d.push(l(c,q,u,s));return d}());return n=i(a,c,o,d,u,j,t,b,e),a[u]=n,n}return r=function(){var a,b,d;d=[];for(a=0,b=k.length;a<b;a++)l=k[a],d.push(l(c,v,u));return d}(),n=i(a,c,o,d,u,j,r,b,e),a[u]=n,n},a.template[l]=f,e(f)},r=d.children,s=[];for(p=0,q=r.length;p<q;p++)j=r[p],s.push(f(a,b,l,j,function(a){return n(a)}));return s}return h=function(c,e,f,h){var j,k,n,p;return j=m===""?h:m,n=g(f,j),p=j===l?e:e!=null?e[j]:void 0,k=i(a,c,o,d,n,j,p,b,e),a[n]=k,k},a.template[l]=h,e(h)},g=function(a,b){var c;return b===void 0||b===""?c=a:a===void 0||a===""?c=b:a===b?c=b:c=""+a+"."+b,c},i=function(a,b,c,d,f,g,h,i,j){var k,m,n,o;n={},o=d.textContent?d.textContent:d.value,k=h?h:o,m={};if(g||g===0)n.id=g;d&&e(d,n,r),c==="INPUT"?(_.isObject(k)||(n.value=k),m=b[c](n)):m=b[c](n,k);if(j!=null?j[g]:void 0)h instanceof Array?e(j[g],m,q):e(j[g],m,p);return l(j!=null?j[g]:void 0,i,f,m,a),m},l=function(a,b,c,d,e){var f,g,h,i,j;if(a){i=_.keys(o),j=[];for(g=0,h=i.length;g<h;g++)f=i[g],j.push(n(f,o[f],a,b,c,d,e));return j}},h=function(a){var b,c,e,f,g,h,i,j,l;if(a.event!=="read"){f=k[a.key],g=a.key.lastIndexOf("."),i=a.key.substring(0,g),e=a.key.substring(g+1),j="value",b=a.key;if(e==="value"||!f)f=k[i],j=e,b=i;if(a.event==="wrote")return f&&k.template[b]&&a.info.value&&a.info.value.isProxy?(l=a.info.value.getRoot?a.info.value.getRoot():a.info.value,$(k[b]).replaceWith(k.template[b](k.html,l,i))):d(a.info,f,"value",p[j]);if(a.event==="added")return c=i+"_add",h=k.template[c](e,a.parent),$(k[i]).append(h)}},m=function(a,b){return k.changeSubscription!==void 0&&k.changeSubscription.unsubscribe(),k.changeSubscription=postal.channel(b).subscribe(h)},n=function(a,b,c,d,e,f,g){var h,i;return h=c[a],h?(i=function(a){return h.apply(c,[d,{id:e,control:g[e],event:b,context:g,info:a}])},f[b]=i):f[b]=function(a){return b==="onchange"&&a.stopPropagation(),g.eventChannel.publish({id:e,model:c,control:g[e],event:b,context:g,info:a})}},this.apply=function(a,c){return f(k,a,b,k.element,function(b){return c(b(k.html,a))})},this.name=a,this.namespace=b,this.fqn="",this.element={},this.eventChannel=postal.channel(b+"_events"),this.html=DOMBuilder.dom,this.template={},this.changeSubscription=void 0,c.resolve(a,function(a){return k.element=a}),m(k,b+"_model"),k}})(window)