/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
define(["jquery","underscore","postal","infuser","DOMBuilder"],function(a,b,c,d){var e;e={elementIdentifier:"data-id",templateIdentifier:"data-template"};var f,d,g;f=function(){var b,c;return b=this,c=[],this.appendSource=function(a){return c.push(a)},this.prependSource=function(a){return c.unshift(a)},this.resolve=function(b,d,e){var f,g;return g=0,f=function(){},f=function(){var h;return h=c[g],h?h(b,function(b){return d(a(b)[0])},function(){return g++,f()}):e()},f()},b},g=new f,g.appendSource(function(b,c,d){var e;return e=a("#"+b+"-template"),e.length>0?c(e[0]):d()}),d=d||window.infuser,d&&g.appendSource(function(a,b,c){return d.get(a,function(a){return b(a)},function(a){return c()})});var h,i;h=function(){var a;return a=this,this.config=e,this.templates={},this.containerLookup={},this.instanceCache={},this.map=function(b){var c;return c=new j(b),a.templates[b]=c,!0},this.apply=function(b,c,d,e,f){var g,h;return this.containerLookup[c]=a.templates[b],a.templates[b]?(g=a.templates[b],g.apply(c,d,function(b,c,d){return a.instanceCache[b]=d,e(b,c,d)})):d.__template__&&c?(h=d.__template__,a.map(h),a.apply(h,c,d,e,f)):f(c,"render","No template with "+b+" has been mapped")},this.add=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.add(c,d,e)},this.update=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.update(c,d,e)},this.watchEvent=function(b,c,d){var e;if(a.containerLookup[b])return e=a.containerLookup[b],e.watchEvent(b,c,d)},this.ignoreEvent=function(b,c){var d;if(a.containerLookup[b])return d=a.containerLookup[b],d.ignore(b,c)},this.resolver=g,a},i=new h,i;var j;return j=function(c){var d,f,h,i,j,k,l,m;return l=this,h=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},j=function(a,b,c){return l.templates[b]?(c(l.templates[b]),!0):(g.resolve(a,function(a){return l.templates[b]=a,c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},i=function(a){var b;return a!=null?(b=a.attributes[e.templateIdentifier])!=null?b.value:void 0:void 0},f=function(a,b,c,g){var h,k,m,n,o,p,q,r,s,t,u,v,w;if((b!=null?b.nodeType:void 0)&&b.nodeType!==1)return g(function(){return arguments[4](b.nodeValue)});s=i(b)||(b?void 0:a),r=b!=null?(v=b.attributes[e.elementIdentifier])!=null?v.value:void 0:void 0,q=a+(r?"."+r:"");if(s)return j(s,q+"."+s,function(b){return f(a,b,c,g)});n=b.childNodes,m=n.length,p=function(a){var e;return e=d(b,r,q,a,c),l.factories[q]=e,g(e)};if(n.length>0){o=[],h=function(a){o.push(a);if(o.length===m)return p(o)},w=[];for(t=0,u=n.length;t<u;t++)k=n[t],w.push(f(q,k,c,h));return w}return p([])},d=function(a,c,d,e,g){var i;return i=a.tagName.toUpperCase(),function(m,n,o,p,q){var r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;C=p===void 0?c:p,B=h(o,C,!0,l.name),G=(n!=null?n[C]:void 0)||n,E=G!=null?G.__template__:void 0,G=(G!=null?G.value:void 0)||G,G=b.isFunction(G)?G.call(n):G;if(E)return delete G.__template__,g[B]=!0,l.templates[E]?l.templates[E](m,n,o,p,q):j(E,E,function(a){return f(d,a,g,function(a){return l.templates[E]=a,a(m,n,o,p,q)})});s=e.length;if(e&&s>0){t=!b.isString(G)&&(G!=null?G.length:void 0)?G:G!=null?G.items:void 0,u=t!=null?t.length:void 0;if(t&&u){r=e.slice(0),l.factories[B+"_add"]=function(a,b){var c,d,f,g,h,i,j,k;c=arguments[4],f=new Array(e),d=0,h=function(a){f[d++]=a;if(d===s)return c(f)},k=[];for(i=0,j=r.length;i<j;i++)g=r[i],k.push(g(m,b,B,a,h));return k},F=s*u,z=new Array(F),A=0,D=function(b){z[A++]=b;if(A===F)return q(k(i,a,B,C,c!==void 0,z,n,m))},I=[];for(y=0,H=u-1;0<=H?y<=H:y>=H;0<=H?y++:y--)I.push(function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)x=e[a],c.push(x(m,t,B,y,D));return c}());return I}return z=new Array(s),A=0,D=function(b){z[A++]=b;if(A===s)return q(k(i,a,B,C,c!==void 0,z,n,m))},v=function(){var b,c,d;d=[];for(b=0,c=e.length;b<c;b++)w=e[b],d.push(w(m,a.id||!p||!n[p]?G:n[p],B,void 0,D));return d}()}return q(k(i,a,B,C,c!==void 0,G,n,m))}},k=function(c,d,f,g,h,i,j,k){var m,n,o,p;o={},m=b.isString(i)?i:b.isArray(i)?i||(i!=null?i[g]:void 0):(i!=null?i[g]:void 0)||i,m=d.children.length===0&&g===void 0&&(b.isObject(i)||b.isArray(i))?d.textContent:m,n={},h&&(o[e.elementIdentifier]=f),d.className&&(o["class"]=d.className),d.type&&(o.type=d.type),d.value&&(o.value=d.value),d.id&&(o.id=d.id);if(j!=null?(p=j[g])!=null?p["class"]:void 0:void 0)o["class"]=j[g]["class"];return c==="INPUT"?(b.isObject(m)||(o.value=m),n=l.html[c](o)):c==="IMG"?(o=a.extend(o,{src:m.src||m||d.src,alt:m.alt||m||d.alt,width:m.width||d.width||"",height:m.height||d.height||""}),n=l.html[c](o)):c==="A"?(o=a.extend(o,{href:j.link||d.href,alt:j.alt||m||d.alt}),n=l.html[c](o,m)):n=l.html[c](o,m),h&&(l.generated[k][f]=n),n},m=function(a){var b,c,d,e,f;e=l.watching,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(l.watchEvent(a,b.event,b.handler));return f},this.apply=function(b,c,d){var f,g;return f=a.extend(!0,{},c),l.generated[b]={},l.ready?g=l.render(b,f,b,void 0,function(c){var f;return f=a(c)[0],a(f).attr(e.elementIdentifier,b),l.generated[b].top=f,m(b),d(b,f,"render")}):l.deferredApplyCalls.push(function(){return l.apply(b,f,d)})},this.watchEvent=function(c,d,f){return a(l.generated[c].top).on(d,function(a){var b,c;return b=(c=a.target.attributes[e.elementIdentifier])!=null?c.value:void 0,f(l.id,b,a.target,a.type)}),l.watching.push({event:d,handler:f}),l.watching=b.uniq(l.watching)},this.ignoreEvent=function(a,c){return l.generated[a].top&&l.generated[a].top.off(eventname),l.watching=b.reject(l.watching,function(a){return a.event===c})},this.update=function(b,c,d){var e,f,g,h;f=b.lastIndexOf("."),h=b.split(".")[0],g=b.substring(0,f),e=b.substring(f+1);if(l.factories[b])return l.factories[b](h,c,g,e,function(c){var e;return e=a(c)[0],d(b,e,"update")})},this.add=function(b,c,d){var e,f,g,h,i,j;h=b.lastIndexOf("."),j=b.split(".")[0],i=b.substring(0,h),f=b.substring(h+1),e=b+"_add";if(l.factories[e])return g=a(l.generated[j][b])[0].children.length,l.factories[e](g,c,void 0,void 0,function(c){var e;return e=a(c)[1],d(b,e,"add")})},this.name=c,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.generated={},this.changeSubscription=void 0,this.watching=[],this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},f(l.name,void 0,{},function(a){var b,c,d,e,f;l.render=a,l.ready=!0;if(l.deferredApplyCalls.length>0){e=l.deferredApplyCalls,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b());return f}}),l},i})