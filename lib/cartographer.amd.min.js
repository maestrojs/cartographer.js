/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
define(["jquery","underscore","postal","infuser","DOMBuilder"],function(a,b,c,d){var e;e={elementIdentifier:"data-id",templateIdentifier:"data-template"};var f,g,h,i;g=function(a,b,c){var d,e,f,g,h,i,j,k,l;c||(c=1),j=a.length*c,h=new Array(j),e=0,i=function(a,c){e++,h[a]=c;if(e===j)return b(h)},d=0,l=[];for(g=0,k=c-1;0<=k?g<=k:g>=k;0<=k?g++:g--)l.push(function(){var b,c,e;e=[];for(b=0,c=a.length;b<c;b++)f=a[b],f(function(a){return i(d,a)}),e.push(d++);return e}());return l},h=function(a,b,c){var d,e,g,h;d=c.length,g=new Array(d);for(e=0,h=d-1;0<=h?e<=h:e>=h;0<=h?e++:e--)g[e]=f(a,b,c[e]);return g},i=function(a,b,c){var d,e,g,h;d=b.length,g=new Array(d);for(e=0,h=d-1;0<=h?e<=h:e>=h;0<=h?e++:e--)g[e]=f(a,b[e],c);return g},f=function(a,b,c){return function(d){return b.apply(a,c.concat(d))}};var j,d,k;j=function(){var b,c;return b=this,c=[],this.appendSource=function(a){return c.push(a)},this.prependSource=function(a){return c.unshift(a)},this.resolve=function(b,d,e){var f,g;return g=0,f=function(){},f=function(){var h;return h=c[g],h?h(b,function(b){return d(a(b))},function(){return g++,f()}):e()},f()},b},k=new j,k.appendSource(function(b,c,d){var e;return e=a("#"+b+"-template"),e.length>0?c(e[0]):d()}),d=d||window.infuser,d&&k.appendSource(function(a,b,c){return d.get(a,function(a){return b(a)},function(a){return c()})});var l,m;l=function(){var a;return a=this,this.config=e,this.templates={},this.containerLookup={},this.instanceCache={},this.map=function(b){var c;return c=new n(b),a.templates[b]=c,!0},this.apply=function(b,c,d,e,f){var g,h;return this.containerLookup[c]=a.templates[b],a.templates[b]?(g=a.templates[b],g.apply(c,d,function(b,c,d){return a.instanceCache[b]=d,e(b,c,d)})):d.__template__&&c?(h=d.__template__,a.map(h),a.apply(h,c,d,e,f)):f(c,"render","No template with "+b+" has been mapped")},this.add=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.add(c,d,e)},this.update=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.update(c,d,e)},this.watchEvent=function(b,c,d){var e;if(a.containerLookup[b])return e=a.containerLookup[b],e.watchEvent(b,c,d)},this.ignoreEvent=function(b,c){var d;if(a.containerLookup[b])return d=a.containerLookup[b],d.ignore(b,c)},this.resolver=k,a},m=new l,m;var n;return n=function(c){var d,f,j,l,m,n,o,p,q,r,s,t,u;return t=this,m=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},r=function(a,b,c){return t.templates[b]?(c(t.templates[b]),!0):(k.resolve(a,function(a){return c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},n=function(a){var b;return a!=null?(b=a.attributes[e.templateIdentifier])!=null?b.value:void 0:void 0},f=function(a,b,c,j){var k,l,m,o,p,q,s,u,v,w,x,y,z;if((b!=null?b.length:void 0)&&(!b.nodeType||b.nodeType===1)){if(b.length>1){for(u=0,y=total-1;0<=y?u<=y:u>=y;0<=y?u++:u--)k=[a,b[u],c];return x=h(t,f,k),g(x,function(a){var b;return b=i(t,a,[templateInstance,model,fqn,id]),g(b,function(a){return j(a)})})}return f(a,b[0],c,j)}return(b!=null?b.nodeType:void 0)&&b.nodeType!==1?j(function(){return arguments[4](b.nodeValue)}):(w=b?w=n(b):a,s=b!=null?(z=b.attributes[e.elementIdentifier])!=null?z.value:void 0:void 0,q=a+(s?"."+s:""),w?c[w]?j(function(){return t.factories[w].apply(t,[].slice.call(arguments,0))}):(c[w]=w,r(w,q+"."+w,function(b){return f(a,b,c,function(a){return t.factories[w]=a,j(a)})})):(o=b.childNodes,m=o.length,p=function(a){var e;return e=d(b,s,q,a,c),t.factories[q]=e,j(e)},o.length>0?(k=function(){var a,b,d;d=[];for(a=0,b=o.length;a<b;a++)l=o[a],d.push([q,l,c]);return d}(),v=h(t,f,k),g(v,p)):p([])))},o=function(a,c){return b.isFunction(a)?a.call(c):a},p=function(a,b){if(a&&a[b])return a[b];return},q=function(a,b,c,d,e,g,h){return t.templates[a]?t.templates[a](b,c,d,e,h):r(a,a,function(i){return f(g.elementFqn,i,templates,function(f){return t.templates[a]=f,f(b,c,d,e,h)})})},l=function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p,q,r,t,u,v,w,x,y,z;p=a>0,p||(a=1),m=f.childrenToCreate,v=m.length*a,o=0,t=new Array(v),u=function(a,e){t[o++]=e,o===v&&g(s(f.tag,f.element,d,a,f.elementId,t,c,b));if(o>v)return console.log("BUSTED, SON!")},r=0,i=0,z=[];for(q=0,y=a-1;0<=y?q<=y:q>=y;0<=y?q++:q--){for(w=0,x=m.length;w<x;w++)n=m[w],k=e,l=c,j=d,e===void 0&&p&&(k=q,l=c[k],j=""+d+"."+k),h=0,n(b,l,j,k,function(a){return h++,u(k,a)}),i++;z.push(r++)}return z},j=function(a,c,d,e,f,g){var h,i,j,k,n,r,u,v,w,x,y,z,A,B;return r=f.elementId,e=r||e,v=r!==void 0&&r!=="",u=v?e:"",A=m(d,u,!1,t.name),z=o(c.__template__,c),x=o((B=c[e])!=null?B.__template__:void 0,c),y=o(p(c[e],"__value__")||c[e],c),j=v?c[e]:c,z?(delete c.__template__,q(z,a,c,d,e,f,function(a){return console.log("Hay, I got a thingy back from "+z)})):x?(delete c[e].__template__,q(z,a,c,d,e,f,g)):(i=f!=null?f.childrenToCreate.slice(0):void 0,h=i.length,h>0?(k=p(y,"__items__")||y,n=k?k.length:0,w=n&&!b.isString(k)?k:void 0,t.factories[A+"_add"]=function(b,c,d){return l(0,a,c,A,b,f,d)},w?l(n,a,j,A,void 0,f,g):l(0,a,j,A,e,f,g)):g(s(f.tag,f.element,A,e,v,y,c,a)))},d=function(a,b,c,d,e){var f,g;return g=a.tagName.toUpperCase(),f={tag:g,element:a,elementId:b,elementFqn:c,childrenToCreate:d,templates:e},function(a,b,c,d,e){return j(a,b,c,d,f,e)}},s=function(c,d,f,g,h,i,j,k){var l,m,n,o;n={},l=b.isString(i)?i:b.isArray(i)?i||(i!=null?i[g]:void 0):(i!=null?i[g]:void 0)||i,l=d.children.length===0&&g===void 0&&(b.isObject(i)||b.isArray(i))?d.textContent:l,m={},h&&(n[e.elementIdentifier]=f),d.className&&(n["class"]=d.className),d.type&&(n.type=d.type),d.value&&(n.value=d.value),d.id&&(n.id=d.id);if(j!=null?(o=j[g])!=null?o["class"]:void 0:void 0)n["class"]=j[g]["class"];return c==="INPUT"?(b.isObject(l)||(n.value=l),m=t.html[c](n)):c==="IMG"?(n=a.extend(n,{src:l.src||l||d.src,alt:l.alt||l||d.alt,width:l.width||d.width||"",height:l.height||d.height||""}),m=t.html[c](n)):c==="A"?(n=a.extend(n,{href:j.link||d.href,alt:j.alt||l||d.alt}),m=t.html[c](n,l)):m=t.html[c](n,l),h&&(t.generated[k][f]=m),m},u=function(a){var b,c,d,e,f;e=t.watching,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(t.watchEvent(a,b.event,b.handler));return f},this.apply=function(b,c,d){var f,g;return f=a.extend(!0,{},c),t.generated[b]={},t.ready?g=t.render(b,f,b,void 0,function(c){var f;return f=a(c)[0],a(f).attr(e.elementIdentifier,b),t.generated[b].top=f,u(b),d(b,f,"render")}):t.deferredApplyCalls.push(function(){return t.apply(b,f,d)})},this.watchEvent=function(c,d,f){return a(t.generated[c].top).on(d,function(a){var b,c;return b=(c=a.target.attributes[e.elementIdentifier])!=null?c.value:void 0,f(t.id,b,a.target,a.type)}),t.watching.push({event:d,handler:f}),t.watching=b.uniq(t.watching)},this.ignoreEvent=function(a,c){return t.generated[a].top&&t.generated[a].top.off(eventname),t.watching=b.reject(t.watching,function(a){return a.event===c})},this.update=function(a,b,c){var d,e,f,g;e=a.lastIndexOf("."),g=a.split(".")[0],f=a.substring(0,e),d=a.substring(e+1);if(t.factories[a])return t.factories[a](g,b,f,d,function(b){var d;return d=b,c(a,d,"update")})},this.add=function(b,c,d){var e,f,g,h,i,j;h=b.lastIndexOf("."),j=b.split(".")[0],i=b.substring(0,h),f=b.substring(h+1),e=b+"_add";if(t.factories[e])return g=a(t.generated[j][b])[0].children.length,t.factories[e](g,c,function(a){var c;return c=a,d(b,c,"add")})},this.name=c,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.generated={},this.changeSubscription=void 0,this.watching=[],this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},f(t.name,void 0,{},function(a){var b,c,d,e,f;t.render=a,t.ready=!0;if(t.deferredApplyCalls.length>0){e=t.deferredApplyCalls,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b());return f}}),t},m})