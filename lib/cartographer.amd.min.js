/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
define(["jquery","underscore","postal","infuser","DOMBuilder"],function(a,b,c,d){var e;e={elementIdentifier:"map-id",templateIdentifier:"template-id"};var f,d,g;f=function(){var b,c;return b=this,c=[],this.appendSource=function(a){return c.push(a)},this.prependSource=function(a){return c.unshift(a)},this.resolve=function(b,d,e){var f,g;return g=0,f=function(){},f=function(){var h;return h=c[g],h?h(b,function(b){return d(a(b)[0])},function(){return g++,f()}):e()},f()},b},g=new f,g.appendSource(function(b,c,d){var f;return f=a("["+e.elementIdentifier+'="'+b+'-template"]'),f.length>0?c(f[0]):d()}),d=d||window.infuser,d&&g.appendSource(function(a,b,c){return d.get(a,function(a){return b(a)},function(a){return c()})});var h,i;h=function(){var a;return a=this,this.config=e,this.templates={},this.map=function(b,c){var d;return d=new u(b,c),a.templates[b]=d,!0},this.apply=function(b,c,d,e){var f;return a.templates[b]?(f=a.templates[b],f.apply(c,function(a,b,c){return d(a,b,c)})):c.__template__&&b?(a.map(b,c.__template__,c),a.apply(b,c,d,e)):e(b,"render","No template with "+b+" has been mapped")},this.resolver=g,a},i=new h,i;var j,k,l,m;j={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},k={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},l={hide:"hidden",title:"title",value:"value","class":"className"},m={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var n,o,p,q,r,s,t;p=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},n=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},t=function(a,c,d,e){var f,g,h,i;if(b.isArray(e)){i=[];for(g=0,h=e.length;g<h;g++)f=e[g],i.push(n(c,f,a[d]));return i}return n(c,e,a[d])},o=function(a,c,d){var e,f,g,h,i;if(a&&c){h=b.keys(d),i=[];for(f=0,g=h.length;f<g;f++)e=h[f],i.push(t(a,c,e,d[e]));return i}},s=function(a,b){return a===b},r=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},q=function(a,c){var d,e;if(b(a[c]).isArray())return(d=a[c])!=null?(e=d[0])!=null?e.__template__:void 0:void 0};var u;u=function(c,d){var f,h,i,j,n,q,r;return q=this,j=function(a,b,c){return q.templates[b]?(c(q.templates[b]),!0):(g.resolve(a,function(a){return q.templates[b]=a,c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},i=function(a){var b;return a!=null?(b=a.attributes[e.templateIdentifier])!=null?b.value:void 0:void 0},h=function(a,b,c,d){var g,k,l,m,n,o,p,r,s,t,u,v,w;if((b!=null?b.nodeType:void 0)&&b.nodeType!==1)return d(function(){return b.nodeValue});s=i(b)||(b?void 0:q.name),r=b!=null?(v=b.attributes[e.elementIdentifier])!=null?v.value:void 0:void 0,p=a+(r?"."+r:"");if(s)return j(s,p+"."+s,function(b){return h(a,b,c,d)});m=b.childNodes,l=m.length,o=function(a){var e;return e=f(b,r,p,a,c),q.factories[p]=e,d(e)};if(m.length>0){n=[],g=function(a){n.push(a);if(n.length===l)return o(n)},w=[];for(t=0,u=m.length;t<u;t++)k=m[t],w.push(h(p,k,c,g));return w}return o([])},f=function(a,b,c,d,e){var f;return f=a.tagName.toUpperCase(),function(g,i,k){var l,m,o,r,s,t,u,v,w,x,y,z;w=k===void 0?b:k,v=p(i,w,!0,q.name),y=w===void 0?g:g!=null?g[w]:void 0,y=(y!=null?y.value:void 0)||y,x=y!=null?y.__template__:void 0;if(x&&!e[v])return e[v]=!0,j(x,x,function(a){return h(c,a,e,function(a){return a(g,i,k)})});if(d&&d.length>0){m=(y!=null?y.length:void 0)?y:y!=null?y.items:void 0;if(m&&m.length){u=[],l=d.slice(0),q.factories[v+"_add"]=function(a,b){var c,d,e,f;f=[];for(d=0,e=l.length;d<e;d++)c=l[d],f.push(c(b,v,a));return f};for(t=0,z=m.length-1;0<=z?t<=z:t>=z;0<=z?t++:t--)u.push(function(){var a,b,c;c=[];for(a=0,b=d.length;a<b;a++)s=d[a],c.push(s(m,v,t));return c}());return n(f,a,v,w,b!==void 0,u,g)}return o=function(){var a,b,c;c=[];for(a=0,b=d.length;a<b;a++)r=d[a],c.push(r(y,v));return c}(),n(f,a,v,w,b!==void 0,o,g)}return n(f,a,v,w,b!==void 0,y,g)}},n=function(a,c,d,f,g,h,i){var j,n,p;p={},j=b.isArray(h)&&!b.isString(h)?h||(h!=null?h[f]:void 0):(h!=null?h[f]:void 0)||h,j=c.children.length===0&&f===void 0?c.textContent:j,n={},g&&(p[e.elementIdentifier]=d),c&&o(c,p,m),a==="INPUT"?(b.isObject(j)||(p.value=j),n=q.html[a](p)):n=q.html[a](p,j);if(i!=null?i[f]:void 0)h instanceof Array?o(i[f],n,l):o(i[f],n,k);return g&&(q[d]=n),n},r=function(){var a,b,c,d,e;d=q.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(q.watchEvent(a.event,a.handler));return e},this.apply=function(b,c){return q.ready?(q.top=q.render(b,q.id),a(q.top).attr(e.elementIdentifier,q.id),r(),c(q.id,"render",q.top)):q.deferredApplyCalls.push(function(){return q.apply(b,c)})},this.watchEvent=function(c,d){return q.top&&a(q.top).on(c,function(a){var b,c;return b=(c=a.target.attributes[e.elementIdentifier])!=null?c.value:void 0,d(q.id,b,a.target,a.type)}),q.watching.push({event:c,handler:d}),q.watching=b.uniq(q.watching)},this.ignoreEvent=function(a){return q.top&&q.top.off(eventname),q.watching=b.reject(q.watching,function(b){return b.event===a})},this.update=function(a,b,c){var d,e,f,g;e=a.lastIndexOf("."),g=a.substring(0,e),d=a.substring(e+1);if(q.factories[a])return f=q.factories[a](b,g,d),c(a,"update",f)},this.add=function(a,b,c){var d,e,f,g,h,i;g=a.lastIndexOf("."),i=a.substring(0,g),e=a.substring(g+1),d=a+"_add";if(q.factories[d])return f=q[a].children.length,h=q.factories[d](f,b),c(a,"add",h)},this.name=d,this.id=c,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},h(q.id,void 0,{},function(a){var b,c,d,e,f;q.render=a,q.ready=!0;if(q.deferredApplyCalls.length>0){e=q.deferredApplyCalls,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b());return f}}),q};var v,w;v=function(){var a;return a=this,this.apply=function(a){var b,d;return d=a.template,b=a.model,i.apply(d,b,function(a,b,e){return c.publish("cartographer","render."+d,{template:d,markup:e,operation:"render"})},function(a){return c.publish("cartographer","render."+a,{template:d,error:a,operation:"render"})})},this.map=function(a){return i.map(a.template,a.name)},this.resolver=function(a){return a.order==="prepend"?i.resolver.prependSource(a.resolver):i.resolver.appendSource(a.resolver)},this.add=function(a){var b,d,e,f;return f=a.template,b=a.id,d=a.model,e=i.templates[f],e.add(b,d,function(a,d,e){return c.publish("cartographer","render.{templateId}",{template:f,parent:b,markup:e,operation:"add"})})},this.update=function(a){var b,d,e,f;return f=a.template,b=a.id,d=a.model,e=i.templates[f],e.update(b,d,function(a,d,e){return c.publish("cartographer","render.{templateId}",{template:f,id:b,markup:e,operation:"update"})})},this.watch=function(a){var b;return b=i.templates[a.template],b.watchEvent(a.event,function(a,b,d,e){return c.publish("cartographer."+a,""+b+"."+e,{element:d})})},this.ignore=function(a){var b;return b=i.templates[a.template],b.ignoreEvent(a.event)},c.subscribe("cartographer","api",function(b,c){var d;return d=b.operation,a[d](b)}),c.subscribe("postal","subscription.*",function(b,c){var d,e,f;if(b.exchange.match(/^cartographer[.]*/)){f=b.exchange.split(".")[1];if(i.templates[f]){e=b.topic.split("."),d={template:f,event:e[e.length-1]};if(c.topic==="subscription.created"&&b.exchange.match(/^cartographer/))return a.watch(d);if(b.exchange.match(/^cartographer/))return a.ignore(d)}}})},w=new v})