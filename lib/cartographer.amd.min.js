/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
define(["jquery","underscore","postal","infuser","DOMBuilder"],function(a,b,c,d){var e;e={elementIdentifier:"map-id"};var f,d,g;f=function(){var b,c;return b=this,c=[],this.appendSource=function(a){return c.push(a)},this.prependSource=function(a){return c.unshift(a)},this.resolve=function(b,d,e){var f,g;return g=0,f=function(){},f=function(){var h;return h=c[g],h?h(b,function(b){return d(a(b)[0])},function(){return g++,f()}):e()},f()},b},g=new f,g.appendSource(function(b,c,d){var f;return f=a("["+e.elementIdentifier+'="'+b+'-template"]'),f.length>0?c(f[0]):d()}),d=d||window.infuser,d&&g.appendSource(function(a,b,c){return d.get(a,function(a){return b(a)},function(a){return c()})});var h,i;h=function(){var a;return a=this,this.config=e,this.templates={},this.map=function(b,c){var d;return d=new u(b,c),a.templates[b]=d,!0},this.apply=function(b,c,d,e){var f;return a.templates[b]?(f=a.templates[b],f.apply(c,function(a,b,c){return d(a,b,c)})):c.__template__&&b?(a.map(b,c.__template__,c),a.apply(b,c,d,e)):e(b,"render","No template with "+b+" has been mapped")},this.resolver=g,a},i=new h,i;var j,k,l,m;j={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},k={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},l={hide:"hidden",title:"title",value:"value","class":"className"},m={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var n,o,p,q,r,s,t;p=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},n=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},t=function(a,c,d,e){var f,g,h,i;if(b.isArray(e)){i=[];for(g=0,h=e.length;g<h;g++)f=e[g],i.push(n(c,f,a[d]));return i}return n(c,e,a[d])},o=function(a,c,d){var e,f,g,h,i;if(a&&c){h=b.keys(d),i=[];for(f=0,g=h.length;f<g;f++)e=h[f],i.push(t(a,c,e,d[e]));return i}},s=function(a,b){return a===b},r=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},q=function(a,c){var d,e;if(b(a[c]).isArray())return(d=a[c])!=null?(e=d[0])!=null?e.__template__:void 0:void 0};var u;u=function(c,d){var f,h,i,j,n,t,u,v;return u=this,i=function(a,b,c,d,e){return a()&&!d[c]?(g.resolve(b,function(a){return d[c]=!0,e(a)},function(){return console.log("Could not resolve tempalte "+b)}),!0):!1},h=function(a,b,c,d,f){var g,h,j,k,l,m,o,q;if(c&&c.nodeType&&c.nodeType!==1)return d(function(){return c});g=(c!=null?(q=c.attributes[e.elementIdentifier])!=null?q.value:void 0:void 0)||"",j=p(b,g,u.name,!0)||u.id,h=!c,l=r(a,g)||u.name,o=function(){return!s(j,b)&&r(a,g)||h},b=!b||b===""?u.id:b,m=b+"."+j,k=function(c){return n(a,b,c,d,f)};if(!i(o,l,m,f,k))return n(a,b,c,d,f)},f=function(a,b,c,d,e){var f;return f=function(f,g,h){var i,k,l,m,n,o,q,r,s,t,v,w;t=c===""?h:c,s=p(g,t,!0,u.name),v=(t===s||t===void 0?f:f[t])||f,v=(v!=null?v.value:void 0)||v;if(e){l=(v!=null?v.length:void 0)?v:v!=null?v.items:void 0;if(l&&l.length){r=[],k=e.slice(0),u.template[s+"_add"]=function(a,b){var c,d,e,f;f=[];for(d=0,e=k.length;d<e;d++)c=k[d],f.push(c(b,s,a));return f};for(q=0,w=l.length-1;0<=w?q<=w:q>=w;0<=w?q++:q--)r.push(function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)o=e[a],c.push(o(l,s,q));return c}());return i=j(a,b,s,t,r,d,f),u[s]=i,i}return m=function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)n=e[a],c.push(n(v,s));return c}(),i=j(a,b,s,t,m,d,f),u[s]=i,i}return i=j(a,b,s,t,v,d,f),u[s]=i,i}},t=function(a,b,c,d,e,g,i,j){var k,l,m,n,o,p,q;l=g.length,m=[],n=function(g){var h;if(g.nodeType!==void 0&&g.nodeType!==1)return i(g);m.push(g);if(m.length===l)return h=f(a,d,e,b,m),u.template[c]=h,i(h)},q=[];for(o=0,p=g.length;o<p;o++)k=g[o],q.push(h(b,c,k,n,j));return q},n=function(a,b,c,d,g){var h,j,k,l,m,n,o,r,s,v,w;l=(c!=null?(w=c.attributes[e.elementIdentifier])!=null?w.value:void 0:void 0)||"",m=p(b,l,!0,u.name),r=c.tagName.toUpperCase(),s=q(a,l),v=b+"."+l,o=function(){return s},n=function(b){var e;return e=b.length>1?b:[b],t(r,a,m,c,l,e,d,g)};if(!i(o,s,v,g,n))return h=c.childNodes,j=h.length,j>0?t(r,a,m,c,l,h,d,g):(k=f(r,c,l,a),u.template[m]=k,d(k))},j=function(a,c,d,f,g,h,i){var j,n,p;p={},j=b.isArray(g)&&!b.isString(g)?g||(g!=null?g[f]:void 0):(g!=null?g[f]:void 0)||g,j=c.children.length===0&&f===void 0?c.textContent:j,n={};if(f||f===0)p[e.elementIdentifier]=d;c&&o(c,p,m),a==="INPUT"?(b.isObject(j)||(p.value=j),n=u.html[a](p)):n=u.html[a](p,j);if(i!=null?i[f]:void 0)g instanceof Array?o(i[f],n,l):o(i[f],n,k);return n},v=function(){var a,b,c,d,e;d=u.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(u.watchEvent(a.event,a.handler));return e},this.apply=function(b,c){return h(b,u.id,u.element,function(d){return u.top=d(b,u.id),a(u.top).attr(e.elementIdentifier,u.id),v(),c(u.id,"render",u.top)},{})},this.watchEvent=function(c,d){return u.top&&a(u.top).on(c,function(a){var b,c;return b=(c=a.target.attributes[e.elementIdentifier])!=null?c.value:void 0,d(u.id,b,a.target,a.type)}),u.watching.push({event:c,handler:d}),u.watching=b.uniq(u.watching)},this.ignoreEvent=function(a){return u.top&&u.top.off(eventname),u.watching=b.reject(u.watching,function(b){return b.event===a})},this.update=function(a,b,c){var d,e,f,g;e=a.lastIndexOf("."),g=a.substring(0,e),d=a.substring(e+1);if(u.template[a])return f=u.template[a](b,g,d),c(a,"update",f)},this.add=function(a,b,c){var d,e,f,g,h,i;g=a.lastIndexOf("."),i=a.substring(0,g),e=a.substring(g+1),d=a+"_add";if(u.template[d])return f=u[a].children.length,h=u.template[d](f,b),c(a,"add",h)},this.name=d,this.id=c,this.fqn="",this.element=void 0,this.html=DOMBuilder.dom,this.template={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],g.resolve(d,function(a){return u.element=a},function(){return console.log("No template could be found for "+d)}),u};var v,w;v=function(){var a;return a=this,this.apply=function(a){var b,d;return d=a.template,b=a.model,i.apply(d,b,function(a,b,e){return c.publish("cartographer","render."+d,{template:d,markup:e,operation:"render"})},function(a){return c.publish("cartographer","render."+a,{template:d,error:a,operation:"render"})})},this.map=function(a){return i.map(a.template,a.name)},this.resolver=function(a){return a.order==="prepend"?i.resolver.prependSource(a.resolver):i.resolver.appendSource(a.resolver)},this.add=function(a){var b,d,e,f;return f=a.template,b=a.id,d=a.model,e=i.templates[f],e.add(b,d,function(a,d,e){return c.publish("cartographer","render.{templateId}",{template:f,parent:b,markup:e,operation:"add"})})},this.update=function(a){var b,d,e,f;return f=a.template,b=a.id,d=a.model,e=i.templates[f],e.update(b,d,function(a,d,e){return c.publish("cartographer","render.{templateId}",{template:f,id:b,markup:e,operation:"update"})})},this.watch=function(a){var b;return b=i.templates[a.template],b.watchEvent(a.event,function(a,b,d,e){return c.publish("cartographer."+a,""+b+"."+e,{element:d})})},this.ignore=function(a){var b;return b=i.templates[a.template],b.ignoreEvent(a.event)},c.subscribe("cartographer","api",function(b,c){var d;return d=b.operation,a[d](b)}),c.subscribe("postal","subscription.*",function(b,c){var d,e,f;if(b.exchange.match(/^cartographer[.]*/)){f=b.exchange.split(".")[1];if(i.templates[f]){e=b.topic.split("."),d={template:f,event:e[e.length-1]};if(c.topic==="subscription.created"&&b.exchange.match(/^cartographer/))return a.watch(d);if(b.exchange.match(/^cartographer/))return a.ignore(d)}}})},w=new v})