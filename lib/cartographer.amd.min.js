/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
define(["jquery","underscore","postal","infuser","DOMBuilder"],function(a,b,c,d){var e;e={elementIdentifier:"data-id",templateIdentifier:"data-template"};var f,d,g;f=function(){var b,c;return b=this,c=[],this.appendSource=function(a){return c.push(a)},this.prependSource=function(a){return c.unshift(a)},this.resolve=function(b,d,e){var f,g;return g=0,f=function(){},f=function(){var h;return h=c[g],h?h(b,function(b){return d(a(b))},function(){return g++,f()}):e()},f()},b},g=new f,g.appendSource(function(b,c,d){var e;return e=a("#"+b+"-template"),e.length>0?c(e[0]):d()}),d=d||window.infuser,d&&g.appendSource(function(a,b,c){return d.get(a,function(a){return b(a)},function(a){return c()})});var h,i;h=function(){var a;return a=this,this.config=e,this.templates={},this.containerLookup={},this.instanceCache={},this.map=function(b){var c;return c=new j(b),a.templates[b]=c,!0},this.apply=function(b,c,d,e,f){var g,h;return this.containerLookup[c]=a.templates[b],a.templates[b]?(g=a.templates[b],g.apply(c,d,function(b,c,d){return a.instanceCache[b]=d,e(b,c,d)})):d.__template__&&c?(h=d.__template__,a.map(h),a.apply(h,c,d,e,f)):f(c,"render","No template with "+b+" has been mapped")},this.add=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.add(c,d,e)},this.update=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.update(c,d,e)},this.watchEvent=function(b,c,d){var e;if(a.containerLookup[b])return e=a.containerLookup[b],e.watchEvent(b,c,d)},this.ignoreEvent=function(b,c){var d;if(a.containerLookup[b])return d=a.containerLookup[b],d.ignore(b,c)},this.resolver=g,a},i=new h,i;var j;return j=function(c){var d,f,h,i,j,k,l,m,n,o,p,q,r;return q=this,j=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},o=function(a,b,c){return q.templates[b]?(c(q.templates[b]),!0):(g.resolve(a,function(a){return c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},k=function(a){var b;return a!=null?(b=a.attributes[e.templateIdentifier])!=null?b.value:void 0:void 0},f=function(a,b,c,g){var h,i,j,l,m,n,p,r,s,t,u,v,w,x,y,z,A,B,C,D;if((b!=null?b.length:void 0)&&(!b.nodeType||b.nodeType===1)){if(b.length>1){x=b.length,t=0,u=new Array(x),v=function(a){u[t++]=a,console.log("got factory "+a+" for index "+t);if(t===x)return g(function(a,b,c,d,e){var f,g,h,i;i=[];for(g=0,h=u.length;g<h;g++)f=u[g],i.push(f(a,b,c,d,e));return i})},C=[];for(s=0,A=x-1;0<=A?s<=A:s>=A;0<=A?s++:s--)C.push(f(a,b[s],c,v));return C}return f(a,b[0],c,g)}if((b!=null?b.nodeType:void 0)&&b.nodeType!==1)return g(function(){return arguments[4](b.nodeValue)});w=b?w=k(b):a,r=b!=null?(B=b.attributes[e.elementIdentifier])!=null?B.value:void 0:void 0,p=a+(r?"."+r:"");if(w)return c[w]?g(function(){return q.factories[w].apply(q,[].slice.call(arguments,0))}):(c[w]=w,o(w,p+"."+w,function(b){return f(a,b,c,function(a){return q.factories[w]=a,g(a)})}));l=b.childNodes,j=l.length,n=function(a){var e;return e=d(b,r,p,a,c),q.factories[p]=e,g(e)};if(l.length>0){m=[],h=function(a){m.push(a);if(m.length===j)return n(m)},D=[];for(y=0,z=l.length;y<z;y++)i=l[y],D.push(f(p,i,c,h));return D}return n([])},l=function(a,c){return b.isFunction(a)?a.call(c):a},m=function(a,b){if(a&&a[b])return a[b];return},n=function(a,b,c,d,e,g,h){return q.templates[a]?q.templates[a](b,c,d,e,h):o(a,a,function(i){return f(g.elementFqn,i,templates,function(f){return q.templates[a]=f,f(b,c,d,e,h)})})},i=function(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,q,r,s,t,u;n=a>0,n||(a=1),k=f.childrenToCreate,s=k.length*a,m=0,q=new Array(s),r=function(a,e){q[m++]=e;if(m>=s)return g(p(f.tag,f.element,d,a,f.elementId,q,c,b))},u=[];for(o=0,t=a-1;0<=t?o<=t:o>=t;0<=t?o++:o--)u.push(function(){var a,f,g;g=[];for(a=0,f=k.length;a<f;a++)l=k[a],i=e,j=c,h=d,e===void 0&&n&&(i=o,j=c[i],h=""+d+"."+i),g.push(l(b,j,h,i,function(a){return r(i,a)}));return g}());return u},h=function(a,c,d,e,f,g){var h,k,o,r,s,t,u,v,w,x,y,z,A,B,C;return t=f.elementId,e=t||e,v=t!==void 0&&t!=="",u=v?e:"",A=j(d,u,!1,q.name),z=l(c.__template__,c),x=l((C=c[e])!=null?C.__template__:void 0,c),y=l(m(c[e],"__value__")||c[e],c),o=v?c[e]:c,B="",x&&(B=x,delete c[e].__template__),z&&(B=z,delete c.__template__),B?n(B,a,c,d,e,f,g):(k=f!=null?f.childrenToCreate.slice(0):void 0,h=k.length,h>0?(r=m(y,"__items__")||y,s=r?r.length:0,w=s&&!b.isString(r)?r:void 0,q.factories[A+"_add"]=function(b,c,d){return i(0,a,c,A,b,f,d)},w?i(s,a,o,A,void 0,f,g):i(0,a,o,A,e,f,g)):g(p(f.tag,f.element,A,e,v,y,c,a)))},d=function(a,b,c,d,e){var f,g;return g=a.tagName.toUpperCase(),f={tag:g,element:a,elementId:b,elementFqn:c,childrenToCreate:d,templates:e},function(a,b,c,d,e){return h(a,b,c,d,f,e)}},p=function(c,d,f,g,h,i,j,k){var l,m,n,o;n={},l=b.isString(i)?i:b.isArray(i)?i||(i!=null?i[g]:void 0):(i!=null?i[g]:void 0)||i,l=d.children.length===0&&g===void 0&&(b.isObject(i)||b.isArray(i))?d.textContent:l,m={},h&&(n[e.elementIdentifier]=f),d.className&&(n["class"]=d.className),d.type&&(n.type=d.type),d.value&&(n.value=d.value),d.id&&(n.id=d.id);if(j!=null?(o=j[g])!=null?o["class"]:void 0:void 0)n["class"]=j[g]["class"];return c==="INPUT"?(b.isObject(l)||(n.value=l),m=q.html[c](n)):c==="IMG"?(n=a.extend(n,{src:l.src||l||d.src,alt:l.alt||l||d.alt,width:l.width||d.width||"",height:l.height||d.height||""}),m=q.html[c](n)):c==="A"?(n=a.extend(n,{href:j.link||d.href,alt:j.alt||l||d.alt}),m=q.html[c](n,l)):m=q.html[c](n,l),h&&(q.generated[k][f]=m),m},r=function(a){var b,c,d,e,f;e=q.watching,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(q.watchEvent(a,b.event,b.handler));return f},this.apply=function(b,c,d){var f,g;return f=a.extend(!0,{},c),q.generated[b]={},q.ready?g=q.render(b,f,b,void 0,function(c){var f;return f=a(c)[0],a(f).attr(e.elementIdentifier,b),q.generated[b].top=f,r(b),d(b,f,"render")}):q.deferredApplyCalls.push(function(){return q.apply(b,f,d)})},this.watchEvent=function(c,d,f){return a(q.generated[c].top).on(d,function(a){var b,c;return b=(c=a.target.attributes[e.elementIdentifier])!=null?c.value:void 0,f(q.id,b,a.target,a.type)}),q.watching.push({event:d,handler:f}),q.watching=b.uniq(q.watching)},this.ignoreEvent=function(a,c){return q.generated[a].top&&q.generated[a].top.off(eventname),q.watching=b.reject(q.watching,function(a){return a.event===c})},this.update=function(a,b,c){var d,e,f,g;e=a.lastIndexOf("."),g=a.split(".")[0],f=a.substring(0,e),d=a.substring(e+1);if(q.factories[a])return q.factories[a](g,b,f,d,function(b){var d;return d=b,c(a,d,"update")})},this.add=function(b,c,d){var e,f,g,h,i,j;h=b.lastIndexOf("."),j=b.split(".")[0],i=b.substring(0,h),f=b.substring(h+1),e=b+"_add";if(q.factories[e])return g=a(q.generated[j][b])[0].children.length,q.factories[e](g,c,function(a){var c;return c=a,d(b,c,"add")})},this.name=c,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.generated={},this.changeSubscription=void 0,this.watching=[],this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},f(q.name,void 0,{},function(a){var b,c,d,e,f;q.render=a,q.ready=!0;if(q.deferredApplyCalls.length>0){e=q.deferredApplyCalls,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b());return f}}),q},i})