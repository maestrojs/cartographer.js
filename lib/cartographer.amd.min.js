/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
define(["jquery","underscore","infuser","DOMBuilder"],function(a,b,c){var d,e,f,g,h,i,j;d={elementIdentifier:"data-id",templateIdentifier:"data-template"},e=function(a,b,c,d,e,f,g){var h,i,j,m,n,o,p,q,r,s,t;n=f.childrenToCreate,p=a>0,a||(a=1),j=e,m=c,i=d,h=[];for(q=0,t=a-1;0<=t?q<=t:q>=t;0<=t?q++:q--){e===void 0&&p&&(j=q,m=c[j],i=""+d+"."+j);for(r=0,s=n.length;r<s;r++)o=n[r],h.push(k(self,o,[b,m,i,j]))}return l(h,g)},f=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},g=function(a){var b;return a!=null?(b=a.attributes[d.templateIdentifier])!=null?b.value:void 0:void 0},h=function(a,c){return b.isFunction(a)?a.call(c):a},i=function(b,c){return a(c.DIV({},b)).html()},j=function(a,b){if(a&&a[b])return a[b];return};var k,l,m,n;l=function(a,b,c){var d,e,f,g,h,i,j,k,l;c||(c=1),j=a.length*c,h=new Array(j),e=0,i=function(a,c){e++,h[a]=c;if(e===j)return b(h)},d=0,l=[];for(g=0,k=c-1;0<=k?g<=k:g>=k;0<=k?g++:g--)l.push(function(){var b,c,e;e=[];for(b=0,c=a.length;b<c;b++)f=a[b],f(function(a){return i(d,a)}),e.push(d++);return e}());return l},m=function(a,b,c){var d,e,f,g;d=c.length,f=new Array(d);for(e=0,g=d-1;0<=g?e<=g:e>=g;0<=g?e++:e--)f[e]=k(a,b,c[e]);return f},n=function(a,b,c){var d,e,f,g;d=b.length,f=new Array(d);for(e=0,g=d-1;0<=g?e<=g:e>=g;0<=g?e++:e--)f[e]=k(a,b[e],c);return f},k=function(a,b,c){return function(d){return b.apply(a,c.concat(d))}};var o,c,p;o=function(){function b(){this.sources=[]}return b.prototype.appendSource=function(a){return this.sources.push(a)},b.prototype.prependSource=function(a){return this.sources.unshift(a)},b.prototype.resolve=function(b,c,d){var e,f,g;return g=this,f=0,e=function(){},e=function(){var h;return h=g.sources[f],h?h(b,function(b){return c(a(b))},function(){return f++,e()}):d()},e()},b}(),p=new o,p.appendSource(function(b,c,d){var e;return e=a("#"+b+"-template"),e.length>0?c(e[0]):d()}),c=c||window.infuser,c&&p.appendSource(function(a,b,d){return c.get(a,function(a){return b(a)},function(a){return d()})});var q,r;q=function(){function a(){this.config=d,this.templates={},this.containerLookup={},this.instanceCache={},this.resolver=p}return a.prototype.map=function(a){var b;return b=new s(a),this.templates[a]=b,!0},a.prototype.render=function(a,b,c,d,e){var f,g,h;return f=this,this.containerLookup[b]=this.templates[a],this.templates[a]?(g=this.templates[a],g.apply(b,c,function(a,b,c){return f.instanceCache[a]=c,d(a,b,c)})):c.__template__&&b?(h=c.__template__,this.map(h),this.render(h,b,c,d,e)):e(b,"render","No template with "+a+" has been mapped")},a.prototype.add=function(a,b,c,d){var e;if(this.containerLookup[a])return e=this.containerLookup[a],e.add(b,c,d)},a.prototype.update=function(a,b,c,d){var e;if(this.containerLookup[a])return e=this.containerLookup[a],e.update(b,c,d)},a}(),r=new q,r;var s;return s=function(){function c(a){var b;this.name=a,b=this,this.name=a,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.deferredApplyCalls=[],this.renderTemplate=function(){},this.ready=!1,this.factories={},this.crawl(this.name,void 0,{},function(a){var c,d,e,f,g;b.renderTemplate=a,b.ready=!0;if(b.deferredApplyCalls.length>0){f=b.deferredApplyCalls,g=[];for(d=0,e=f.length;d<e;d++)c=f[d],g.push(c());return g}})}return c.prototype.handleTemplate=function(a,b,c){var d;return d=this,d.templates[b]?(c(d.templates[b]),!0):(p.resolve(a,function(a){return c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},c.prototype.buildCreateCall=function(a,b,c,d,e){var f,g,h;return g=this,h=a.tagName.toUpperCase(),f={tag:h,element:a,elementId:b,elementFqn:c,childrenToCreate:d,templates:e},function(a,b,c,d,e){return g.create(a,b,c,d,f,e)}},c.prototype.crawl=function(a,b,c,e){var f,h,i,j,k,o,p,q,r,s,t,u,v,w;return s=this,(b!=null?b.length:void 0)&&(!b.nodeType||b.nodeType===1)?b.length>1?(u=b.length,f=function(){var d,e;e=[];for(q=0,d=u-1;0<=d?q<=d:q>=d;0<=d?q++:q--)e.push([a,b[q],c]);return e}(),v=m(s,s.crawl,f),l(v,function(a){return e(function(b,c,d,e,f){var g;return g=n(s,a,[b,c,d,e]),l(g,function(a){return f(a)})})})):s.crawl(a,b[0],c,e):(b!=null?b.nodeType:void 0)&&b.nodeType!==1?e(function(){return arguments[4](b.nodeValue)}):(t=b?t=g(b):a,p=b!=null?(w=b.attributes[d.elementIdentifier])!=null?w.value:void 0:void 0,o=a+(p?"."+p:""),t?c[t]?e(function(){return s.factories[t].apply(s,[].slice.call(arguments,0))}):(c[t]=t,s.handleTemplate(t,o+"."+t,function(b){return s.crawl(a,b,c,function(a){return s.factories[t]=a,e(a)})})):(j=b.childNodes,i=j.length,k=function(a){var d;return d=s.buildCreateCall(b,p,o,a,c),s.factories[o]=d,e(d)},j.length>0?(f=function(){var a,b,d;d=[];for(a=0,b=j.length;a<b;a++)h=j[a],d.push([o,h,c]);return d}(),r=m(s,s.crawl,f),l(r,k)):k([])))},c.prototype.handleModelTemplate=function(a,b,c,d,e,f,g){var h;return h=this,h.templates[a]?h.templates[a](b,c,d,e,g):h.handleTemplate(a,a,function(i){return h.crawl(f.elementFqn,i,templates,function(f){return h.templates[a]=f,f(b,c,d,e,g)})})},c.prototype.create=function(a,c,d,g,i,k){var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;y=this,q=i.elementId,g=q||g,s=q!==void 0&&q!=="",r=s?g:"",x=f(d,r,!1,y.name);if(s&&!c[g]){k("");return}return w=h(c.__template__,c),u=h((z=c[g])!=null?z.__template__:void 0,c),v=h(j(c[g],"__value__")||c[g]||j(c,"__value__"),c),n=s?c[g]:c,w?(delete c.__template__,y.handleModelTemplate(w,a,c,d,g,i,function(b){return k(y.makeTag(i.tag,i.element,x,g,s,b,c,a))})):u?(delete c[g].__template__,y.handleModelTemplate(w,a,c,d,g,i,k)):(m=i!=null?i.childrenToCreate.slice(0):void 0,l=m.length,l>0?(o=j(v,"__items__")||v,p=o?o.length:0,t=p&&!b.isString(o)?o:void 0,y.factories[x+"_add"]=function(b,c,d){return x=""+x+"."+b,e(0,a,c,x,b,i,d)},t?e(p,a,n,x,void 0,i,function(b){return k(y.makeTag(i.tag,i.element,x,g,i.elementId,b,c,a))}):e(0,a,n,x,g,i,function(b){return k(y.makeTag(i.tag,i.element,x,g,i.elementId,b,c,a))})):k(y.makeTag(i.tag,i.element,x,g,s,v,c,a)))},c.prototype.makeTag=function(c,e,f,g,h,i,j,k){var l,m,n,o,p;o=this,n={},l=b.isString(i)?i:b.isArray(i)?i||(i!=null?i[g]:void 0):(i!=null?i[g]:void 0)||i,l=e.children.length===0&&g===void 0&&(b.isObject(i)||b.isArray(i))?e.textContent:l,m={},h&&(n[d.elementIdentifier]=f),e.className&&(n["class"]=e.className),e.type&&(n.type=e.type),e.value&&(n.value=e.value),e.id&&(n.id=e.id);if(j!=null?(p=j[g])!=null?p["class"]:void 0:void 0)n["class"]=j[g]["class"];return c==="INPUT"?(b.isObject(l)||(n.value=l),m=o.html[c](n)):c==="IMG"?(n=a.extend(n,{src:l.src||l||e.src,alt:l.alt||l||e.alt,width:l.width||e.width||"",height:l.height||e.height||""}),m=o.html[c](n)):c==="A"?(n=a.extend(n,{href:j.link||e.href,alt:j.alt||l||e.alt}),m=o.html[c](n,l)):m=o.html[c](n,l),m},c.prototype.render=function(b,c,e){var f,g;return g=this,f=a.extend(!0,{},c),g.ready?g.renderTemplate(b,f,b,void 0,function(c){var f;return f={},c.length?f=i(c,g.html):(f=a(c)[0],a(f).attr(d.elementIdentifier,b)),e(b,f,"render")}):g.deferredApplyCalls.push(function(){return g.render(b,f,e)})},c.prototype.update=function(a,b,c){var d,e,f,g,h;g=this,e=a.lastIndexOf("."),h=a.split(".")[0],f=a.substring(0,e),d=a.substring(e+1);if(g.factories[a])return g.factories[a](h,b,f,d,function(b){var d;return d=b,c(a,d,"update")})},c.prototype.add=function(b,c,e){var f,g,h,j,k,l,m;l=this,j=b.lastIndexOf("."),m=b.split(".")[0],k=b.substring(0,j),g=b.substring(j+1),f=b+"_add";if(l.factories[f])return h=a("["+d.elementIdentifier+'="'+b+'"]').children.length+1,l.factories[f](h,c,function(a){var c;return c=i(a,l.html),e(b,c,"add")})},c}(),r})