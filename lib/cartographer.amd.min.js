/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
define(["jQuery","underscore","postal","infuser","DOMBuilder"],function(a,b,c,d,e){var f;f={elementIdentifier:"map-id"};var g,d,h;g=function(){var b,c;return b=this,c=[],this.appendSource=function(a){return c.push(a)},this.prependSource=function(a){return c.unshift(a)},this.resolve=function(b,d,e){var f,g;return g=0,f=function(){},f=function(){var h;return h=c[g],h?h(b,function(b){return d(a(b)[0])},function(){return g++,f()}):e()},f()},b},h=new g,h.appendSource(function(b,c,d){var e;return e=a("["+f.elementIdentifier+'="'+b+'-template"]'),e.length>0?c(e[0]):d()}),d=d||window.infuser,d&&h.appendSource(function(a,b,c){return d.get(a,function(a){return b(a)},function(a){return console.log("got "+a),c()})});var i,j;i=function(){var a;return a=this,this.config=f,this.templates={},this.map=function(b,c){var d;return d=new v(b,c),a.templates[b]=d,!0},this.apply=function(b,d,e,f){var g;return e=e||function(a){return c.publish("cartographer","render."+b,{id:b,markup:a})},f=f||function(a){return c.publish("cartographer","render."+b+".error",a)},a.templates[b]?(g=a.templates[b],g.apply(d,function(a){return e(a)})):d.__template__&&b?(a.map(b,d.__template__,d),a.apply(b,d,e,f)):f("No template with "+b+" has been mapped")},this.resolver=h,a},j=new i,c.subscribe("cartographer","api.*",function(a,b){if(b.topic==="api.map")return j.map(a.id,a.name);if(b.topic==="api.apply")return j.apply(a.id,a.model);if(b.topic==="api.prepend.resolver")return j.resolver.prependSource(a.resolver);if(b.topic==="api.append.resolver")return j.resolver.appendSource(a.resolver)}),c.subscribe("cartographer","event.*",function(a,b){var c;if(b.topic==="event.watch")return c=j.templates[a.id],c!=null?c.watchEvent(a.event):void 0;if(b.topic==="event.ignore")return c=j.templates[a.id],c!=null?c.ignoreEvent(a.event):void 0}),c.subscribe("postal","subscription.*",function(a,b){var c,d,e;if(b.topic==="subscription.created"&&a.exchange.match(/^cartographer[.].+/)){e=a.exchange.split(".")[1],d=j.templates[e];if(d)return c=a.topic.split("."),d.watchEvent(c[c.length-1])}else if(a.exchange.match(/^cartographer[.]*/)){e=a.exchange.split(".")[1],d=j.templates[e];if(d)return c=a.topic.split("."),d.ignoreEvent(c[c.length-1])}}),j;var k,l,m,n;k={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},l={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},m={hide:"hidden",title:"title",value:"value","class":"className"},n={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var o,p,q,r,s,t,u;q=function(a,b,c,d){var e,f,g,h;g=a||"";if(d){if(a===""&&b===c)return"";g=g===c?"":g}return f=b||"",e=g!==""&&f!==""?".":"",h=""+g+e+f,h},o=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},u=function(a,c,d,e){var f,g,h,i;if(b.isArray(e)){i=[];for(g=0,h=e.length;g<h;g++)f=e[g],i.push(o(c,f,a[d]));return i}return o(c,e,a[d])},p=function(a,c,d){var e,f,g,h,i;if(a&&c){h=b.keys(d),i=[];for(f=0,g=h.length;f<g;f++)e=h[f],i.push(u(a,c,e,d[e]));return i}},t=function(a,b){return a===b},s=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},r=function(a,c){var d,e;if(b(a[c]).isArray())return(d=a[c])!=null?(e=d[0])!=null?e.__template__:void 0:void 0};var v;v=function(d,g){var i,j,k,o,u,v,w,x;return v=this,j=function(a,b,c,d,e){var g,i,j,k,l,m;return g=(c!=null?(m=c.attributes[f.elementIdentifier])!=null?m.value:void 0:void 0)||"",g=g===v.name?"":g,j=q(b,g,v.name,!0),i=!c,k=s(a,g)||v.name,l=!e[b+"."+j],l&&!t(j,b)&&s(a,g)||i?h.resolve(k,function(c){return e[b+"."+j]=!0,u(a,b,c,d,e)},function(){return console.log("No template could be found for "+k)}):u(a,b,c,d,e)},i=function(a,b,c,d,e){var f;return f=function(f,g,h){var i,j,k,l,m,n,p,r,s,t,u,w;t=c===""?h:c,s=q(g,t,!0,v.name),u=(t===s||t===void 0?f:f[t])||f;if(u!=null?u.value:void 0)u=u.value;k=(u!=null?u.length:void 0)?u:u!=null?u.items:void 0;if(k&&k.length){r=[],j=e[0],v.template[s+"_add"]=function(a,b){return j(b,s,a)};for(p=0,w=k.length-1;0<=w?p<=w:p>=w;0<=w?p++:p--)r.push(function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)n=e[a],c.push(n(k,s,p));return c}());return i=o(a,b,s,t,r,d,f),v[s]=i,i}return l=function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)m=e[a],c.push(m(u,s));return c}(),i=o(a,b,s,t,l,d,f),v[s]=i,i}},u=function(a,b,c,d,e){var g,k,l,m,n,p,s,t,u,w,x,y,z,A,B,C;c||console.log("ELEMENT IS NULL AND SHOULDN'T BE!!!!!!"),p=(c!=null?(z=c.attributes[f.elementIdentifier])!=null?z.value:void 0:void 0)||"",s=q(b,p,!0,v.name),u=c.tagName.toUpperCase(),w=r(a,p);if(w&&!e[b+"."+p])return h.resolve(w,function(f){var g,h,k,l,m,n,o,q,r;e[b+"."+p]=!0,k=f.length>1?f:[f],l=k.length;if(l>0){m=[],n=function(b){var e;m.push(b);if(m.length===l)return e=i(u,c,p,a,m),v.template[s]=e,d(e)},h=function(a){return n(a)},r=[];for(o=0,q=k.length;o<q;o++)g=k[o],r.push(j(a,s,g,h,e));return r}},function(){return console.log("No template could be found for "+w)});l=(A=c.children)!=null?A.length:void 0;if(l>0){m=[],t=function(b){var e;m.push(b);if(m.length===l)return e=i(u,c,p,a,m),v.template[s]=e,d(e)},k=function(a){return t(a)},B=c.children,C=[];for(x=0,y=B.length;x<y;x++)g=B[x],C.push(j(a,s,g,k,e));return C}return n=function(b,d,e){var f,g,h,i;h=p===""?e:p,g=q(d,h,!0,v.name),i=h===g||h===void 0?b:b[h];if(i!=null?i.value:void 0)i=i.value;return f=o(u,c,g,h,i,a,b),v[g]=f,f},v.template[s]=n,d(n)},o=function(a,c,d,e,g,h,i){var j,k,o,q;o={},q=c.textContent?c.textContent:c.value,j=(g!=null?g[e]:void 0)||g&&e||c.children.length>1?g||(g!=null?g[e]:void 0):q,k={};if(e||e===0)o[f.elementIdentifier]=e;c&&p(c,o,n),a==="INPUT"?(b.isObject(j)||(o.value=j),k=v.html[a](o)):k=v.html[a](o,j);if(i!=null?i[e]:void 0)g instanceof Array?p(i[e],k,m):p(i[e],k,l);return k},k=function(a){var b,d,e,f,g,h,i;e=v[a.key],h=a.operation,f=a.key.lastIndexOf("."),i=a.key.substring(0,f),d=a.key.substring(f+1);if(h==="add"){b=a.key+"_add";if(v.template[b])return g=v.template[b](a.value,i,d),c.publish("cartographer","markup.added",{operation:"added",parent:i,markup:g})}else if(h="change")return v.template[a.key](a.value,i,d,function(a){return c.publish("cartographer","markup.created",{operation:"created",parent:i,markup:a})})},w=function(){return v.changeSubscription!==void 0&&v.changeSubscription.unsubscribe(),v.changeSubscription=c.subscribe("cartographer","template."+v.id+".*",k)},x=function(){var a,b,c,d,e;d=v.watching,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(v.watchEvent(a));return e},this.apply=function(a,b){return j(a,"",v.element,function(c){return v.top=c(a,""),x(),b(v.top)},{})},this.watchEvent=function(d){return v.top&&a(v.top).on(d,function(a){var b,d;return b=((d=a.target.attributes[f.elementIdentifier])!=null?d.value:void 0)+"."+a.type,c.publish("cartographer."+v.id,b,a.target)}),v.watching.push(d),v.watching=b.uniq(v.watching)},this.ignoreEvent=function(a){return v.top.off(eventname),v.watching=b.reject(v.watching,function(b){return b===a})},this.name=g,this.id=d,this.fqn="",this.element=void 0,this.html=e.dom,this.template={},this.top=void 0,this.changeSubscription=void 0,this.watching=[],h.resolve(g,function(a){return v.element=a},function(){return console.log("No template could be found for "+g)}),w(),v}})