/*
  Cartographer.js
  Author: Alex Robson <@A_Robson>
  License: MIT ( http://www.opensource.org/licenses/mit-license )
  Version: 0.2.0
*/
define(["jquery","underscore","postal","infuser","DOMBuilder"],function(a,b,c,d){var e;e={elementIdentifier:"data-id",templateIdentifier:"data-template"};var f,d,g;f=function(){var b,c;return b=this,c=[],this.appendSource=function(a){return c.push(a)},this.prependSource=function(a){return c.unshift(a)},this.resolve=function(b,d,e){var f,g;return g=0,f=function(){},f=function(){var h;return h=c[g],h?h(b,function(b){return d(a(b)[0])},function(){return g++,f()}):e()},f()},b},g=new f,g.appendSource(function(b,c,d){var e;return e=a("#"+b+"-template"),e.length>0?c(e[0]):d()}),d=d||window.infuser,d&&g.appendSource(function(a,b,c){return d.get(a,function(a){return b(a)},function(a){return c()})});var h,i;h=function(){var a;return a=this,this.config=e,this.templates={},this.containerLookup={},this.instanceCache={},this.map=function(b){var c;return c=new u(b),a.templates[b]=c,!0},this.apply=function(b,c,d,e,f){var g,h;return this.containerLookup[c]=a.templates[b],a.templates[b]?(g=a.templates[b],g.apply(c,d,function(b,c,d){return a.instanceCache[b]=d,e(b,c,d)})):d.__template__&&c?(h=d.__template__,a.map(h),a.apply(h,c,d,e,f)):f(c,"render","No template with "+b+" has been mapped")},this.add=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.add(c,d,e)},this.update=function(b,c,d,e){var f;if(a.containerLookup[b])return f=a.containerLookup[b],f.update(c,d,e)},this.watchEvent=function(b,c,d){var e;if(a.containerLookup[b])return e=a.containerLookup[b],e.watchEvent(b,c,d)},this.ignoreEvent=function(b,c){var d;if(a.containerLookup[b])return d=a.containerLookup[b],d.ignore(b,c)},this.resolver=g,a},i=new h,i;var j,k,l,m;j={click:"onclick",dblclick:"ondblclick",mousedown:"onmousedown",mouseup:"onmouseup",mouseover:"onmouseover",mousemove:"onmousemove",mouseout:"onmouseout",keydown:"onkeydown",keypress:"onkeypress",keyup:"onkeyup",select:"onselect",change:"onchange",focus:"onfocus",blur:"onblur",scroll:"onscroll",resize:"onresize",submit:"onsubmit"},k={hide:"hidden",title:"title","class":"className",value:["value","textContent"]},l={hide:"hidden",title:"title",value:"value","class":"className"},m={id:"id",name:"name",title:"title",className:"class",type:"type",width:"width",height:"height",value:"value"};var n,o,p,q,r,s,t;p=function(a,b,c,d){var e,f,g,h;return g=a||"",f=b===void 0?"":b,e=g!==""&&f!==""?".":"",h=""+g+e+f,h},n=function(a,b,c){var d;d=a[b];if(d||c)return a[b]=c||d},t=function(a,c,d,e){var f,g,h,i;if(b.isArray(e)){i=[];for(g=0,h=e.length;g<h;g++)f=e[g],i.push(n(c,f,a[d]));return i}return n(c,e,a[d])},o=function(a,c,d){var e,f,g,h,i;if(a&&c){h=b.keys(d),i=[];for(f=0,g=h.length;f<g;f++)e=h[f],i.push(t(a,c,e,d[e]));return i}},s=function(a,b){return a===b},r=function(a,b){var c;return(c=a[b])!=null?c.__template__:void 0},q=function(a,c){var d,e;if(b(a[c]).isArray())return(d=a[c])!=null?(e=d[0])!=null?e.__template__:void 0:void 0};var u;u=function(c){var d,f,h,i,j,n,q;return n=this,i=function(a,b,c){return n.templates[b]?(c(n.templates[b]),!0):(g.resolve(a,function(a){return n.templates[b]=a,c(a)},function(){return console.log("Could not resolve tempalte "+a)}),!0)},h=function(a){var b;return a!=null?(b=a.attributes[e.templateIdentifier])!=null?b.value:void 0:void 0},f=function(a,b,c,g){var j,k,l,m,o,p,q,r,s,t,u,v,w;if((b!=null?b.nodeType:void 0)&&b.nodeType!==1)return g(function(){return arguments[4](b.nodeValue)});s=h(b)||(b?void 0:a),r=b!=null?(v=b.attributes[e.elementIdentifier])!=null?v.value:void 0:void 0,q=a+(r?"."+r:"");if(s)return i(s,q+"."+s,function(b){return f(a,b,c,g)});m=b.childNodes,l=m.length,p=function(a){var e;return e=d(b,r,q,a,c),n.factories[q]=e,g(e)};if(m.length>0){o=[],j=function(a){o.push(a);if(o.length===l)return p(o)},w=[];for(t=0,u=m.length;t<u;t++)k=m[t],w.push(f(q,k,c,j));return w}return p([])},d=function(a,c,d,e,g){var h;return h=a.tagName.toUpperCase(),function(k,l,m,o,q){var r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I;C=o===void 0?c:o,B=p(m,C,!0,n.name),G=(l!=null?l[C]:void 0)||l,E=G.__template__,delete G.__template__,G=(G!=null?G.value:void 0)||G,G=b.isFunction(G)?G.call(l):G;if(E)return g[B]=!0,n.templates[E]?n.templates[E](k,l,m,o,q):i(E,E,function(a){return f(d,a,g,function(a){return n.templates[E]=a,a(k,l,m,o,q)})});s=e.length;if(e&&s>0){t=(G!=null?G.length:void 0)?G:G!=null?G.items:void 0,u=t!=null?t.length:void 0;if(t&&u){r=e.slice(0),n.factories[B+"_add"]=function(a,b){var c,d,f,g,h,i,j,l;c=arguments[4],f=new Array(e),d=0,h=function(a){f[d++]=a;if(d===s)return c(f)},l=[];for(i=0,j=r.length;i<j;i++)g=r[i],l.push(g(k,b,B,a,h));return l},F=s*u,z=new Array(F),A=0,D=function(b){z[A++]=b;if(A===F)return q(j(h,a,B,C,c!==void 0,z,l,k))},I=[];for(y=0,H=u-1;0<=H?y<=H:y>=H;0<=H?y++:y--)I.push(function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)x=e[a],c.push(x(k,t,B,y,D));return c}());return I}return z=new Array(s),A=0,D=function(b){z[A++]=b;if(A===s)return q(j(h,a,B,C,c!==void 0,z,l,k))},v=function(){var a,b,c;c=[];for(a=0,b=e.length;a<b;a++)w=e[a],c.push(w(k,G,B,void 0,D));return c}()}return q(j(h,a,B,C,c!==void 0,G,l,k))}},j=function(a,c,d,f,g,h,i,j){var p,q,r;r={},p=b.isArray(h)&&!b.isString(h)?h||(h!=null?h[f]:void 0):(h!=null?h[f]:void 0)||h,p=c.children.length===0&&f===void 0?c.textContent:p,q={},g&&(r[e.elementIdentifier]=d),c&&o(c,r,m),a==="INPUT"?(b.isObject(p)||(r.value=p),q=n.html[a](r)):q=n.html[a](r,p);if(i!=null?i[f]:void 0)h instanceof Array?o(i[f],q,l):o(i[f],q,k);return g&&(n.generated[j][d]=q),q},q=function(a){var b,c,d,e,f;e=n.watching,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(n.watchEvent(a,b.event,b.handler));return f},this.apply=function(b,c,d){var f,g;return f=a.extend(!0,{},c),n.generated[b]={},n.ready?g=n.render(b,f,b,void 0,function(c){var f;return f=a(c)[0],a(f).attr(e.elementIdentifier,b),n.generated[b].top=f,q(b),d(b,"render",f)}):n.deferredApplyCalls.push(function(){return n.apply(b,f,d)})},this.watchEvent=function(c,d,f){return n.generated[c].top&&a(n.generated[c].top).on(d,function(a){var b,c;return b=(c=a.target.attributes[e.elementIdentifier])!=null?c.value:void 0,f(n.id,b,a.target,a.type)}),n.watching.push({event:d,handler:f}),n.watching=b.uniq(n.watching)},this.ignoreEvent=function(a,c){return n.generated[a].top&&n.generated[a].top.off(eventname),n.watching=b.reject(n.watching,function(a){return a.event===c})},this.update=function(b,c,d){var e,f,g,h;f=b.lastIndexOf("."),h=b.split(".")[0],g=b.substring(0,f),e=b.substring(f+1);if(n.factories[b])return n.factories[b](h,c,g,e,function(c){var e;return e=a(c)[0],d(b,"update",e)})},this.add=function(b,c,d){var e,f,g,h,i,j;h=b.lastIndexOf("."),j=b.split(".")[0],i=b.substring(0,h),f=b.substring(h+1),e=b+"_add";if(n.factories[e])return g=a(n.generated[j][b])[0].children.length,n.factories[e](g,c,void 0,void 0,function(c){var e;return e=a(c)[1],d(b,"add",e)})},this.name=c,this.fqn="",this.html=DOMBuilder.dom,this.templates={},this.generated={},this.changeSubscription=void 0,this.watching=[],this.deferredApplyCalls=[],this.render=function(){},this.ready=!1,this.factories={},f(n.name,void 0,{},function(a){var b,c,d,e,f;n.render=a,n.ready=!0;if(n.deferredApplyCalls.length>0){e=n.deferredApplyCalls,f=[];for(c=0,d=e.length;c<d;c++)b=e[c],f.push(b());return f}}),n};var v,w;v=function(){var a;return a=this,this.apply=function(a){var b,d,e;return d=a.name,e=a.template,b=a.model,i.apply(d,e,b,function(a,b,d){return c.publish("cartographer","render."+e,{template:e,markup:d,operation:"render"})},function(a){return c.publish("cartographer","render."+a,{template:e,error:a,operation:"render"})})},this.map=function(a){return i.map(a.name)},this.resolver=function(a){return a.order==="prepend"?i.resolver.prependSource(a.resolver):i.resolver.appendSource(a.resolver)},this.add=function(a){var b,d,e;return e=a.template,b=a.id,d=a.model,i.add(e,b,d,function(a,d,f){return c.publish("cartographer","render.{templateId}",{template:e,parent:b,markup:f,operation:"add"})})},this.update=function(a){var b,d,e;return e=a.template,b=a.id,d=a.model,i.update(e,b,d,function(a,d,f){return c.publish("cartographer","render.{templateId}",{template:e,id:b,markup:f,operation:"update"})})},this.watch=function(a){return i.watchEvent(a.template,a.event,function(a,b,d,e){return c.publish("cartographer."+a,""+b+"."+e,{element:d})})},this.ignore=function(a){return i.ignoreEvent(a.template,a.event)},c.subscribe("cartographer","api",function(b,c){var d;return d=b.operation,a[d](b)}),c.subscribe("postal","subscription.*",function(b,c){var d,e,f;if(b.exchange.match(/^cartographer[.]*/)){f=b.exchange.split(".")[1];if(i.templates[f]){e=b.topic.split("."),d={template:f,event:e[e.length-1]};if(c.topic==="subscription.created"&&b.exchange.match(/^cartographer/))return a.watch(d);if(b.exchange.match(/^cartographer/))return a.ignore(d)}}})},w=new v})